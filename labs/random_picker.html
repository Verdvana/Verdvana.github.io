<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>éšæœºæŠ½å–å™¨ï¼ˆä¸‰ç§è¾“å…¥æ–¹å¼ / å»é‡ / ä¸æ”¾å›ï¼‰</title>

  <!-- ä¸é™„ä»¶ä¸€è‡´ï¼šFontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --faint: rgba(255,255,255,0.45);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --accent: #7aa2ff;
      --accent2:#7df0c4;
      --danger:#ff6b6b;
      --ok:#39d98a;
      --warn:#ffd166;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel: rgba(0,0,0,0.04);
        --panel2: rgba(0,0,0,0.06);
        --text: rgba(0,0,0,0.9);
        --muted: rgba(0,0,0,0.62);
        --faint: rgba(0,0,0,0.42);
        --border: rgba(0,0,0,0.10);
        --shadow: 0 18px 50px rgba(8, 15, 35, 0.10);
        --accent:#2b6dff;
        --accent2:#00a37a;
      }
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% -20%, rgba(122,162,255,0.22), transparent 60%),
                  radial-gradient(900px 550px at 20% 0%, rgba(125,240,196,0.18), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
      line-height: 1.5;
    }
    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .wrap{ max-width: 1160px; margin: 0 auto; padding: 28px 18px 80px; }
    .topbar{ display:flex; align-items:flex-start; justify-content:space-between; gap: 16px; margin-bottom: 18px; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{ width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, rgba(122,162,255,0.95), rgba(125,240,196,0.85)); box-shadow: 0 10px 30px rgba(0,0,0,0.22); }
    h1{ font-size: 18px; margin:0; letter-spacing: 0.2px; }
    .subtitle{ margin:2px 0 0; color: var(--muted); font-size: 13px; }
    .pill{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--border); background: rgba(255,255,255,0.02); padding:8px 12px; border-radius: 999px; color: var(--muted); font-size: 12px; }

    .grid{ display:grid; grid-template-columns: 1.05fr 0.95fr; gap: 16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{ border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03)); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .card .hd{ padding: 16px 18px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .card .hd h2{ font-size: 14px; margin:0; letter-spacing: 0.2px; }
    .card .bd{ padding: 16px 18px; }

    .section-title{ display:flex; align-items:center; gap:10px; }
    .dot{ width:10px;height:10px;border-radius:99px; background: var(--accent); box-shadow: 0 0 0 4px rgba(122,162,255,0.18); }
    .dot.green{ background: var(--accent2); box-shadow: 0 0 0 4px rgba(125,240,196,0.16); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    @media (max-width: 640px){ .row{ grid-template-columns: 1fr; } }

    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, button, textarea{ font-family: var(--sans); }
    input, select, textarea{ width:100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); outline: none; background: rgba(255,255,255,0.03); color: var(--text); }
    textarea{ min-height: 120px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: var(--faint); }
    input:focus, select:focus, textarea:focus{ border-color: rgba(122,162,255,0.6); box-shadow: 0 0 0 4px rgba(122,162,255,0.14); }

    .hint{ font-size: 12px; color: var(--faint); margin-top: 6px; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px; }
    button{ border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: var(--text); padding: 10px 12px; border-radius: 12px; cursor: pointer; transition: transform .04s ease, background .2s ease, border-color .2s ease; }
    button:hover{ background: rgba(255,255,255,0.07); border-color: rgba(122,162,255,0.55); }
    button:active{ transform: translateY(1px); }
    .primary{ background: linear-gradient(135deg, rgba(122,162,255,0.95), rgba(125,240,196,0.75)); border: none; color: rgba(0,0,0,0.78); font-weight: 650; }
    .primary:hover{ filter: brightness(1.02); }
    .danger{ border-color: rgba(255,107,107,0.45); color: rgba(255,107,107,0.92); }
    .danger:hover{ background: rgba(255,107,107,0.08); }
    .mini{ padding: 7px 10px; border-radius: 10px; font-size: 12px; }

    .kpi{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 640px){ .kpi{ grid-template-columns: 1fr; } }
    .kpi .box{ border: 1px solid var(--border); border-radius: 14px; padding: 12px 12px; background: rgba(255,255,255,0.03); }
    .kpi .box .t{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .box .v{ font-size: 16px; font-weight: 700; letter-spacing: .2px; }
    .kpi .box .s{ font-size: 12px; color: var(--faint); margin-top: 4px; }

    .split{ height:1px; background: var(--border); margin: 14px 0; }

    .code{ font-family: var(--mono); font-size: 12px; color: var(--muted); white-space: pre-wrap; word-break: break-word; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); font-size: 12px; color: var(--muted); background: rgba(255,255,255,0.02); }
    .badge .b{ width:7px;height:7px;border-radius:99px;background: var(--ok); }
    .badge.warn .b{ background: var(--warn); }

    /* ====== Theme override: manual light/dark ====== */
    html[data-theme="dark"]{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --faint: rgba(255,255,255,0.45);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --accent: #7aa2ff;
      --accent2:#7df0c4;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --panel: rgba(0,0,0,0.04);
      --panel2: rgba(0,0,0,0.06);
      --text: rgba(0,0,0,0.9);
      --muted: rgba(0,0,0,0.62);
      --faint: rgba(0,0,0,0.42);
      --border: rgba(0,0,0,0.10);
      --shadow: 0 18px 50px rgba(8, 15, 35, 0.10);
      --accent:#2b6dff;
      --accent2:#00a37a;
    }

    /* ====== Smooth theme transition ====== */
    html.theme-transition, html.theme-transition body{ transition: background-color .25s ease, color .25s ease; }
    html.theme-transition *:not(input):not(textarea):not(select),
    html.theme-transition *:not(input):not(textarea):not(select)::before,
    html.theme-transition *:not(input):not(textarea):not(select)::after{
      transition: background-color .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, fill .25s ease, stroke .25s ease, opacity .25s ease;
    }
    html.theme-transition input, html.theme-transition textarea, html.theme-transition select{ transition: none !important; }

    /* ====== iOS-like theme switch ====== */
    .theme-switch{ display:flex; align-items:center; gap:10px; user-select:none; }
    .theme-switch .label{ font-size:12px; color: var(--muted); }
    .switch{ position: relative; width: 44px; height: 26px; border-radius: 999px; background: rgba(255,255,255,0.10); border: 1px solid var(--border);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02); transition: background .2s ease, border-color .2s ease, box-shadow .2s ease; }
    @media (prefers-color-scheme: light){ .switch{ background: rgba(0,0,0,0.06); } }
    .switch input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
    .switch .knob{ position:absolute; top: 3px; left: 3px; width: 20px; height: 20px; border-radius: 999px; background: rgba(255,255,255,0.92);
      box-shadow: 0 6px 16px rgba(0,0,0,0.22); transform: translateX(0); transition: transform .2s ease, background .2s ease; }
    html[data-theme="light"] .switch .knob{ background: rgba(255,255,255,0.98); }
    .switch input:checked ~ .knob{ transform: translateX(18px); }
    .switch.on{ background: rgba(125,240,196,0.22); border-color: rgba(125,240,196,0.35); }
    .switch:focus-within{ box-shadow: 0 0 0 4px rgba(122,162,255,0.16); }

    /* ====== Left sidebar + overlay ====== */
    .layout{ display:flex; min-height: 100vh; }
    .sidebar{ --sb-w: 64px; width: var(--sb-w); flex: 0 0 var(--sb-w); height: 100vh; position: sticky; top: 0; z-index: 9998;
      border-right: 1px solid var(--border); background: rgba(255,255,255,0.04); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      display:flex; flex-direction: column; padding: 10px 10px; gap: 10px; transition: width .18s ease, flex-basis .18s ease; }
    html[data-theme="light"] .sidebar{ background: rgba(255,255,255,0.72); }
    .sidebar.is-expanded{ --sb-w: 252px; }
    .main{ flex: 1 1 auto; min-width: 0; }
    .sb-top{ display:flex; align-items:center; gap: 10px; }
    .sb-toggle{ width: 40px; height: 40px; border-radius: 12px; padding: 0; display:grid; place-items:center; border: 1px solid var(--border); background: rgba(255,255,255,0.03); }
    .sb-toggle:hover{ background: rgba(255,255,255,0.07); border-color: rgba(122,162,255,0.55); }
    .sb-toggle i{ font-size: 16px; }
    .sb-logo{ width: 40px; height: 40px; border-radius: 14px; overflow:hidden; border: 1px solid var(--border); flex: 0 0 auto; display:block; }
    .sb-logo img{ width:100%; height:100%; object-fit: cover; display:block; }
    .sb-nav{ display:flex; flex-direction: column; gap: 6px; padding-top: 6px; }
    .sb-item{ display:flex; align-items:center; gap: 12px; width: 100%; border-radius: 12px; padding: 10px 10px; border: 1px solid transparent; color: var(--text);
      background: transparent; text-decoration: none; cursor: pointer; user-select: none; transition: background .16s ease, border-color .16s ease, transform .04s ease; }
    .sb-item:hover{ background: rgba(255,255,255,0.06); border-color: rgba(122,162,255,0.25); }
    .sb-item:active{ transform: translateY(1px); }
    .sb-item i{ width: 20px; text-align:center; opacity: 0.92; }
    .sb-item span{ white-space: nowrap; font-size: 13px; color: var(--text); }
    .sidebar:not(.is-expanded) .sb-item span{ display:none; }
    .sidebar:not(.is-expanded) .sb-top{ flex-direction: column; align-items: stretch; justify-content: flex-start; }
    .sidebar:not(.is-expanded) .sb-logo{ display:block; }
    .sb-sep{ height: 1px; background: var(--border); margin: 6px 2px; }
    .sb-bottom{ margin-top: auto; padding-top: 6px; }
    .sb-back{ border: 1px solid var(--border); background: rgba(255,255,255,0.03); }
    .sb-back:hover{ border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.10); }

    .sb-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,0.35); opacity: 0; pointer-events: none; transition: opacity .16s ease; z-index: 9997; }
    .sb-backdrop.is-active{ opacity: 1; pointer-events: auto; }

    @media (max-width: 720px){
      .sidebar{ position: fixed; left: 0; top: 0; }
      .main{ margin-left: 64px; }
      .sidebar.is-expanded{ box-shadow: 0 18px 60px rgba(0,0,0,0.35); }
      body.sb-lock-scroll{ overflow: hidden; }
    }
    @media print{ .sidebar, .sb-backdrop{ display:none; } .main{ margin-left: 0; } }

    /* ====== App extra ====== */
    .mode-tabs{ display:flex; gap:10px; flex-wrap:wrap; }
    .tab{ display:inline-flex; gap:8px; align-items:center; border:1px solid var(--border); background: rgba(255,255,255,0.02);
      padding:8px 10px; border-radius: 999px; color: var(--muted); font-size: 12px; cursor:pointer; user-select:none;
      transition: background .16s ease, border-color .16s ease; }
    .tab:hover{ background: rgba(255,255,255,0.06); border-color: rgba(122,162,255,0.35); }
    .tab.is-active{ color: rgba(0,0,0,0.78); border: none; background: linear-gradient(135deg, rgba(122,162,255,0.95), rgba(125,240,196,0.75)); font-weight: 700; }

    .pick-display{ border: 1px solid var(--border); border-radius: 14px; padding: 14px 14px; background: rgba(255,255,255,0.03); position: relative; overflow:hidden; }
    .pick-display .label{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .pick-display .value{ font-size: 20px; font-weight: 800; letter-spacing: .2px; line-height: 1.35; word-break: break-word; white-space: pre-wrap; }
    #finalPick{ white-space: pre-wrap; word-break: break-word; }
    .pulse{ animation: pulseGlow .5s ease-in-out infinite alternate; }
    @keyframes pulseGlow{ 0%{ box-shadow: 0 0 0 0 rgba(122,162,255,0.0); } 100%{ box-shadow: 0 0 0 6px rgba(122,162,255,0.10); } }

    .list-mini{ max-height: 220px; overflow:auto; border: 1px solid var(--border); border-radius: 14px; background: rgba(255,255,255,0.02); padding: 8px 10px; font-size: 12px; color: var(--muted); }
    .list-mini code{ font-family: var(--mono); color: var(--text); background: transparent; }

    /* ===== ä¿®å¤ï¼šæ·±è‰²æ¨¡å¼ä¸‹ <select> ä¸‹æ‹‰é€‰é¡¹ç™½åº•ç™½å­— ===== */
    html[data-theme="dark"]{ color-scheme: dark; }
    html[data-theme="light"]{ color-scheme: light; }
    @media (prefers-color-scheme: dark){ html:not([data-theme]){ color-scheme: dark; } }
    @media (prefers-color-scheme: light){ html:not([data-theme]){ color-scheme: light; } }

    html[data-theme="dark"] select option{ background-color: #0b0f14; color: rgba(255,255,255,0.92); }
    html[data-theme="light"] select option{ background-color: #ffffff; color: rgba(0,0,0,0.90); }
    @media (prefers-color-scheme: dark){ html:not([data-theme]) select option{ background-color: #0b0f14; color: rgba(255,255,255,0.92); } }
    @media (prefers-color-scheme: light){ html:not([data-theme]) select option{ background-color: #ffffff; color: rgba(0,0,0,0.90); } }
  </style>
</head>

<body>
<div class="layout" id="appLayout">

  <!-- Sidebarï¼šä¸é™„ä»¶ä¸€è‡´ï¼ˆå†…å®¹/ç»“æ„/æ ·å¼ï¼‰ -->
  <aside class="sidebar" id="sidebar" aria-label="ç«™ç‚¹å¯¼èˆª">
    <div class="sb-top">
      <button class="sb-toggle" id="sbToggle" type="button" aria-label="å±•å¼€/æŠ˜å èœå•" title="å±•å¼€/æŠ˜å èœå•">
        <i class="fa-solid fa-bars" aria-hidden="true"></i>
      </button>
      <a class="sb-logo" href="https://verdvana.cn" title="verdvana.cn">
        <img src="https://verdvana.cn/static/img/avatar.jpg" alt="logo" />
      </a>
    </div>
    <nav class="sb-nav" aria-label="å¿«æ·å…¥å£">
      <a class="sb-item" href="https://verdvana.cn" title="ä¸»é¡µ">
        <i class="fa-solid fa-home" aria-hidden="true"></i><span>ä¸»é¡µ</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/archive/" title="åšæ–‡">
        <i class="fa-solid fa-archive" aria-hidden="true"></i><span>åšæ–‡</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/tags/" title="åˆ†ç±»">
        <i class="fa-solid fa-tags" aria-hidden="true"></i><span>åˆ†ç±»</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/comments/" title="ç•™è¨€">
        <i class="fa-solid fa-comments" aria-hidden="true"></i><span>ç•™è¨€</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/merger/" title="æ‰“èµ">
        <i class="fa-solid fa-coffee" aria-hidden="true"></i><span>æ‰“èµ</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/labs/" title="æ›´å¤š">
        <i class="fa-solid fa-flask" aria-hidden="true"></i><span>æ›´å¤š</span>
      </a>
      <div class="sb-sep" role="separator" aria-hidden="true"></div>
    </nav>
    <div class="sb-bottom">
      <button class="sb-item sb-back" id="sbBack" type="button" title="è¿”å›ä¸Šä¸€çº§">
        <i class="fa-solid fa-arrow-left" aria-hidden="true"></i><span>è¿”å›ä¸Šä¸€çº§</span>
      </button>
    </div>
  </aside>

  <div class="sb-backdrop" id="sbBackdrop" aria-hidden="true"></div>

  <main class="main" id="mainContent">
    <div class="wrap">

      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>éšæœºæŠ½å–å™¨ï¼ˆè¾“å…¥å»é‡ / å¼€å§‹åœæ­¢ / ä¸æ”¾å›å¯é€‰ï¼‰</h1>
            <div class="subtitle">æ”¯æŒï¼šè¾“å…¥æ¡† / CSV è¡Œæ¨¡å¼ / CSV åˆ—æ¨¡å¼ï¼ˆåˆ—èšåˆï¼›å•å…ƒæ ¼å†…é€—å·ç‰‡æ®µè½¬ç©ºæ ¼ï¼‰</div>
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
          <div class="theme-switch">
            <span class="label" id="themeLabel">ç³»ç»Ÿ</span>
            <div class="switch" id="themeSwitchWrap" title="åˆ‡æ¢æ˜æš—æ¨¡å¼ï¼ˆAlt/Option ç‚¹å‡»æˆ–é•¿æŒ‰å¯åˆ‡å›ç³»ç»Ÿï¼‰">
              <input id="themeToggle" type="checkbox" aria-label="åˆ‡æ¢æ˜æš—æ¨¡å¼">
              <span class="knob" aria-hidden="true"></span>
            </div>
          </div>
          <div class="pill"><span>ğŸ²</span><span>é€—å·å¯ç”¨ <span style="font-family:var(--mono);">\,</span> è½¬ä¹‰</span></div>
        </div>
      </div>

      <div class="grid">
        <!-- å·¦ï¼šè¾“å…¥ -->
        <div class="card">
          <div class="hd">
            <div class="section-title"><div class="dot"></div><h2>è¾“å…¥ä¸è§£æ</h2></div>
            <div class="badge warn"><span class="b"></span><span>è§£æåå…¨é‡å»é‡</span></div>
          </div>
          <div class="bd">

            <div class="mode-tabs" id="modeTabs" aria-label="è¾“å…¥æ–¹å¼">
              <div class="tab is-active" data-mode="text"><i class="fa-regular fa-keyboard"></i> è¾“å…¥æ¡†æ¨¡å¼</div>
              <div class="tab" data-mode="csvRow"><i class="fa-regular fa-file-lines"></i> CSV è¡Œæ¨¡å¼</div>
              <div class="tab" data-mode="csvCol"><i class="fa-regular fa-file"></i> CSV åˆ—æ¨¡å¼</div>
            </div>

            <div class="split"></div>

            <div id="mode_text" class="mode-panel">
              <label>è¾“å…¥å…ƒç´ ï¼ˆé€—å·åˆ†éš”ï¼›å…ƒç´ å†…éƒ¨é€—å·ç”¨ \, è½¬ä¹‰ï¼‰</label>
              <textarea id="textInput" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰,æå››,hello\,world,ç‹äº”&#10;è¯´æ˜ï¼š\\ è¡¨ç¤ºå­—é¢åæ–œæ "></textarea>
              <div class="hint">è§£æï¼šé€—å·åˆ†éš”ï¼›<code>\,</code> è¡¨ç¤ºå­—é¢é€—å·ï¼›<code>\\</code> è¡¨ç¤ºå­—é¢åæ–œæ ã€‚</div>
            </div>

            <div id="mode_csvRow" class="mode-panel" style="display:none;">
              <label>ä¸Šä¼  CSVï¼ˆè¡Œæ¨¡å¼ï¼šæ¯ä¸€è¡ŒæŒ‰â€œé€—å·åˆ†éš” + \, è½¬ä¹‰â€è§£æï¼‰</label>
              <input id="csvRowFile" type="file" accept=".csv,text/csv,.txt,text/plain" />
              <div class="row" style="margin-top:12px;">
                <div>
                  <label>æ–‡ä»¶ç¼–ç </label>
                  <select id="csvRowEncoding">
                    <option value="utf-8" selected>UTF-8</option>
                    <option value="gbk">GBKï¼ˆå°è¯•ï¼‰</option>
                  </select>
                  <div class="hint">è‹¥ä¹±ç å»ºè®®å…ˆå¦å­˜ä¸º UTF-8ã€‚</div>
                </div>
                <div>
                  <label>å¿½ç•¥ç©ºè¡Œ</label>
                  <select id="csvRowIgnoreEmpty">
                    <option value="yes" selected>æ˜¯</option>
                    <option value="no">å¦</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="mode_csvCol" class="mode-panel" style="display:none;">
              <label>ä¸Šä¼  CSVï¼ˆåˆ—æ¨¡å¼ï¼šæ¯ä¸€åˆ—èšåˆä¸ºä¸€ä¸ªå…ƒç´ ï¼›å•å…ƒæ ¼å†…é€—å·åˆ†éš”ç‰‡æ®µè½¬ç©ºæ ¼è¿æ¥ï¼‰</label>
              <input id="csvColFile" type="file" accept=".csv,text/csv,.txt,text/plain" />
              <div class="row" style="margin-top:12px;">
                <div>
                  <label>æ–‡ä»¶ç¼–ç </label>
                  <select id="csvColEncoding">
                    <option value="utf-8" selected>UTF-8</option>
                    <option value="gbk">GBKï¼ˆå°è¯•ï¼‰</option>
                  </select>
                </div>
                <div>
                  <label>åˆ—èšåˆè¿æ¥ç¬¦ï¼ˆé»˜è®¤ç©ºæ ¼ï¼‰</label>
                  <select id="csvColJoiner">
                    <option value=" " selected>ç©ºæ ¼</option>
                    <option value="  ">ä¸¤ä¸ªç©ºæ ¼</option>
                    <option value=" | "> | </option>
                  </select>
                </div>
              </div>
              <div class="hint" style="margin-top:10px;">ä¾‹ï¼šç¬¬ä¸€åˆ—ä¸‰è¡Œåˆ†åˆ«æ˜¯ <code>a,b</code> / <code>c</code> / <code>d\,e</code> â†’ åˆ—å…ƒç´ ä¸º <code>a b c d,e</code></div>
            </div>

            <div class="toolbar">
              <button class="primary" id="btnParse"><i class="fa-solid fa-wand-magic-sparkles"></i> è§£æå¹¶å»é‡</button>
              <button id="btnClear"><i class="fa-regular fa-trash-can"></i> æ¸…ç©º</button>
              <button class="mini" id="btnLoadDemo"><i class="fa-regular fa-lightbulb"></i> å¡«å…¥ç¤ºä¾‹</button>
            </div>

            <div class="split"></div>

            <div class="kpi">
              <div class="box">
                <div class="t">å»é‡åå…ƒç´ æ•°é‡</div>
                <div class="v" id="kpiCount">â€”</div>
                <div class="s" id="kpiCountS">â€”</div>
              </div>
              <div class="box">
                <div class="t">å½“å‰çŠ¶æ€</div>
                <div class="v" id="kpiState">å¾…è§£æ</div>
                <div class="s" id="kpiStateS">è¯·å…ˆè§£æè¾“å…¥</div>
              </div>
            </div>

            <div class="split"></div>

            <div class="row">
              <div>
                <label>å‰©ä½™å¯æŠ½å–ï¼ˆä¸æ”¾å›å¼€å¯æ—¶ï¼‰</label>
                <input id="remainingBox" type="text" value="â€”" readonly />
                <div class="hint">ä¸æ”¾å›ï¼šåªåœ¨â€œåœæ­¢â€æ—¶ç§»é™¤æœ€ç»ˆç»“æœï¼ˆæ»šåŠ¨ä¸ä¼šæ¶ˆè€—ï¼‰ã€‚</div>
              </div>
              <div>
                <label>å·²æŠ½å–åˆ—è¡¨ï¼ˆä¸æ”¾å›å¼€å¯æ—¶ï¼‰</label>
                <div class="code" id="pickedList" style="margin:0; max-height:120px; overflow:auto;">â€”</div>
              </div>
            </div>

            <div class="small">è§£æé¢„è§ˆï¼ˆå‰ 50 ä¸ªï¼‰</div>
            <div class="list-mini" id="previewList">â€”</div>

          </div>
        </div>

        <!-- å³ï¼šæŠ½å– -->
        <div class="card">
          <div class="hd">
            <div class="section-title"><div class="dot green"></div><h2>éšæœºæŠ½å–</h2></div>
            <div class="badge"><span class="b"></span><span>å¼€å§‹æ»šåŠ¨ï¼Œåœæ­¢å®šæ ¼</span></div>
          </div>
          <div class="bd">

            <div class="pick-display" id="displayWrap">
              <div class="label">å½“å‰æŠ½åˆ°</div>
              <div class="value" id="currentPick">â€”</div>
            </div>

            <div class="split"></div>

            <div class="row">
              <div>
                <label>æ»šåŠ¨é€Ÿåº¦ï¼ˆæ¯«ç§’/æ¬¡ï¼Œè¶Šå°è¶Šå¿«ï¼‰</label>
                <input id="speedInput" type="number" min="10" step="10" value="80" />
                <div class="hint">é»˜è®¤ 80msï¼Œå»ºè®® 30~120ã€‚</div>
              </div>
              <div>
                <label>æŠ½å–æ¨¡å¼</label>
                <select id="noReplace">
                  <option value="off" selected>æ”¾å›ï¼ˆå¯é‡å¤æŠ½åˆ°ï¼‰</option>
                  <option value="on">ä¸æ”¾å›ï¼ˆåœæ­¢åç§»é™¤å·²æŠ½ä¸­ï¼‰</option>
                </select>
                <div class="hint">ä¸æ”¾å›æŠ½ç©ºåå¯ç‚¹å‡»â€œæ¢å¤å…¨éƒ¨â€ã€‚</div>
              </div>
            </div>

            <div class="row">
              <div>
                <label>æ¯æ¬¡æŠ½å–æ•°é‡</label>
                <select id="drawCount"></select>
                <div class="hint">èŒƒå›´ï¼š1 ~ min(50, å»é‡åå…ƒç´ æ€»æ•°)ã€‚</div>
              </div>
              <div>
                <label>è¯´æ˜</label>
                <div class="code" style="margin:0;">æ¯æ¬¡æ»šåŠ¨ä¼šå±•ç¤ºä¸€ç»„ç»“æœï¼›åœæ­¢åå®šæ ¼æœ¬ç»„ä¸ºæœ€ç»ˆç»“æœã€‚</div>
              </div>
            </div>

            <div class="toolbar">
              <button class="primary" id="btnStart"><i class="fa-solid fa-play"></i> å¼€å§‹æŠ½å–</button>
              <button class="danger" id="btnStop"><i class="fa-solid fa-stop"></i> åœæ­¢</button>
              <button id="btnCopy"><i class="fa-regular fa-copy"></i> å¤åˆ¶æœ€ç»ˆç»“æœ</button>
              <button class="mini" id="btnResetPool"><i class="fa-solid fa-rotate-left"></i> æ¢å¤å…¨éƒ¨</button>
            </div>

            <div class="split"></div>

            <div class="kpi">
              <div class="box">
                <div class="t">æœ€ç»ˆç»“æœï¼ˆåœæ­¢åå®šæ ¼ï¼‰</div>
                <div class="v" id="finalPick">â€”</div>
                <div class="s" id="finalHint">ç‚¹å‡»â€œåœæ­¢â€åç”Ÿæˆ</div>
              </div>
              <div class="box">
                <div class="t">æœ€è¿‘ 10 æ¬¡æ»šåŠ¨è®°å½•ï¼ˆç»„ï¼‰</div>
                <div class="code" id="historyBox" style="margin:0; max-height:140px; overflow:auto;">â€”</div>
              </div>
            </div>

            <div class="split"></div>
            <div class="code" style="margin:0;">å¿«æ·é”®ï¼š
Spaceï¼šå¼€å§‹/åœæ­¢
Rï¼šé‡æ–°å¼€å§‹æ»šåŠ¨
Escï¼šåœæ­¢</div>

          </div>
        </div>

      </div>
    </div>
  </main>
</div>

<script>
  // ======== å·¥å…·ï¼šé€—å·åˆ†å‰²ï¼ˆæ”¯æŒåæ–œæ è½¬ä¹‰ï¼‰ ========
  function splitByUnescapedComma(str){
    const out = [];
    let buf = "";
    let esc = false;
    for(let i=0;i<str.length;i++){
      const ch = str[i];
      if(esc){ buf += ch; esc = false; continue; }
      if(ch === "\\"){ esc = true; continue; }
      if(ch === ","){ out.push(buf); buf = ""; continue; }
      buf += ch;
    }
    if(esc) buf += "\\";
    out.push(buf);
    return out;
  }
  const norm = (s)=>String(s ?? "").trim();
  function parseElementsFromText(text){
    return splitByUnescapedComma(String(text ?? "").replace(/\r\n/g, "\n")).map(norm).filter(x=>x.length>0);
  }

  async function readFileAsText(file, encoding){
    const buf = await file.arrayBuffer();
    try{ return new TextDecoder(encoding, {fatal:false}).decode(buf); }
    catch{ return new TextDecoder('utf-8', {fatal:false}).decode(buf); }
  }

  function parseCSVRowMode(fileText, ignoreEmpty=true){
    const lines = String(fileText ?? "").replace(/\r\n/g,"\n").split("\n");
    const out = [];
    for(const line of lines){
      const raw = line.trimEnd();
      if(ignoreEmpty && raw.trim().length===0) continue;
      out.push(...parseElementsFromText(raw));
    }
    return out;
  }

  function parseCSVColumnMode(fileText, joiner=" "){
    const lines = String(fileText ?? "").replace(/\r\n/g,"\n").split("\n").filter(l=>l.length>0);
    const rows = lines.map(line => splitByUnescapedComma(line).map(s=>s.trim()));
    const colCount = rows.reduce((m,r)=>Math.max(m,r.length), 0);
    const cols = Array.from({length: colCount}, ()=>[]);
    for(const r of rows){
      for(let c=0;c<colCount;c++){
        const cell = (r[c] ?? "").trim();
        if(!cell) continue;
        const inner = splitByUnescapedComma(cell).map(norm).filter(x=>x.length>0);
        if(inner.length) cols[c].push(inner.join(joiner));
      }
    }
    return cols.map(parts => norm(parts.join(joiner))).filter(x=>x.length>0);
  }

  // ======== çŠ¶æ€ ========
  let mode = 'text';
  let masterItems = [];
  let poolItems = [];
  let pickedItems = [];
  let running = false;
  let timer = null;
  let currentGroup = [];
  let finalGroup = [];
  let history = [];

  const $ = (id)=>document.getElementById(id);
  const tabs = Array.from(document.querySelectorAll('#modeTabs .tab'));

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
  }

  function setState(title, sub){
    $('kpiState').textContent = title;
    $('kpiStateS').textContent = sub;
  }

  function setMode(next){
    mode = next;
    tabs.forEach(t => t.classList.toggle('is-active', t.dataset.mode === next));
    $('mode_text').style.display = (next==='text') ? '' : 'none';
    $('mode_csvRow').style.display = (next==='csvRow') ? '' : 'none';
    $('mode_csvCol').style.display = (next==='csvCol') ? '' : 'none';
    setState('å¾…è§£æ', 'è¯·é€‰æ‹©è¾“å…¥å¹¶ç‚¹å‡»â€œè§£æå¹¶å»é‡â€');
  }

  function isNoReplaceEnabled(){ return $('noReplace').value === 'on'; }
  function effectiveList(){ return isNoReplaceEnabled() ? poolItems : masterItems; }

  function getDrawCount(){
    const v = Number($('drawCount').value || 1);
    return Math.max(1, Math.floor(v));
  }

  function updateDrawCountOptions(){
    const sel = $('drawCount');
    const maxN = Math.max(1, Math.min(50, masterItems.length || 1));
    const prev = Number(sel.value || 1);
    sel.innerHTML = '';
    for(let i=1;i<=maxN;i++){
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = String(i);
      sel.appendChild(opt);
    }
    const next = Math.min(prev, maxN);
    sel.value = String(next);
  }

  function updateRemainingUI(){
    if(!masterItems.length){
      $('remainingBox').value = 'â€”';
      $('pickedList').textContent = 'â€”';
      return;
    }
    if(isNoReplaceEnabled()){
      $('remainingBox').value = `${poolItems.length} / ${masterItems.length}`;
      $('pickedList').textContent = pickedItems.length ? pickedItems.map((x,i)=>`${i+1}. ${x}`).join('\n') : 'â€”';
    }else{
      $('remainingBox').value = `ï¼ˆæ”¾å›æ¨¡å¼ï¼‰${masterItems.length}`;
      $('pickedList').textContent = 'â€”';
    }
  }

  function updateCount(){
    $('kpiCount').textContent = masterItems.length ? String(masterItems.length) : 'â€”';
    $('kpiCountS').textContent = masterItems.length ? 'å·²å»é‡ï¼Œå¯å¼€å§‹æŠ½å–' : 'å°šæ— å¯æŠ½å–å…ƒç´ ';
    updateRemainingUI();
    updateDrawCountOptions();
  }

  function updatePreview(){
    if(!masterItems.length){ $('previewList').textContent = 'â€”'; return; }
    const first = masterItems.slice(0, 50);
    const more = masterItems.length > 50 ? `\nâ€¦ï¼ˆè¿˜æœ‰ ${masterItems.length-50} ä¸ªï¼‰` : '';
    $('previewList').innerHTML = first.map((x,i)=>`${i+1}. <code>${escapeHTML(x)}</code>`).join('<br>') + more;
  }

  function formatGroup(arr){
    if(!arr || !arr.length) return 'â€”';
    return arr.join('\n');
  }

  function pushHistory(group){
    if(!group || !group.length) return;
    history.unshift(group.slice());
    history = history.slice(0, 10);
    $('historyBox').textContent = history.length
      ? history.map((g,i)=>`${i+1}. ${g.join(' / ')}`).join('\n')
      : 'â€”';
  }

  function renderCurrentGroup(g){
    $('currentPick').textContent = formatGroup(g);
  }

  function renderFinalGroup(g){
    $('finalPick').textContent = formatGroup(g);
  }

  function sampleKUnique(arr, k){
    const n = arr.length;
    if(n === 0) return [];
    k = Math.min(k, n);
    // Fisher-Yates partial shuffle on indices
    const idx = Array.from({length:n}, (_,i)=>i);
    for(let i=0;i<k;i++){
      const j = i + Math.floor(Math.random() * (n - i));
      const tmp = idx[i]; idx[i] = idx[j]; idx[j] = tmp;
    }
    return idx.slice(0,k).map(i=>arr[i]);
  }

  function computeCurrentGroup(){
    const list = effectiveList();
    if(!list.length) return [];
    const kWanted = getDrawCount();
    const k = Math.min(kWanted, list.length);
    return sampleKUnique(list, k);
  }

  function startRolling(){
    if(running) return;
    if(!effectiveList().length){
      alert(isNoReplaceEnabled()
        ? 'ä¸æ”¾å›æ¨¡å¼ä¸‹å·²æ— å‰©ä½™å…ƒç´ ï¼šç‚¹å‡»â€œæ¢å¤å…¨éƒ¨â€æˆ–é‡æ–°è§£æè¾“å…¥ã€‚'
        : 'è¯·å…ˆè§£æè¾“å…¥ï¼Œç¡®ä¿æœ‰å¯æŠ½å–å…ƒç´ ã€‚');
      return;
    }
    const speed = Math.max(10, Number($('speedInput').value || 80));
    running = true;
    $('displayWrap').classList.add('pulse');
    setState('æŠ½å–ä¸­â€¦', `é€Ÿåº¦ï¼š${speed}ms/æ¬¡ï¼ˆSpace æˆ– Esc å¯åœæ­¢ï¼‰`);
    timer = setInterval(()=>{
      currentGroup = computeCurrentGroup();
      renderCurrentGroup(currentGroup);
      pushHistory(currentGroup);
    }, speed);
  }

  function stopRolling(){
    if(timer){ clearInterval(timer); timer = null; }
    if(!running && (!currentGroup || !currentGroup.length)) return;
    running = false;
    $('displayWrap').classList.remove('pulse');

    if(!currentGroup || !currentGroup.length){
      currentGroup = computeCurrentGroup();
    }
    finalGroup = currentGroup.slice();
    renderFinalGroup(finalGroup);
    $('finalHint').textContent = finalGroup.length ? 'å·²åœæ­¢å¹¶å®šæ ¼å½“å‰å€¼' : 'â€”';

    if(finalGroup.length && isNoReplaceEnabled()){
      // remove all picked from pool (unique already)
      for(const v of finalGroup){
        const idx = poolItems.indexOf(v);
        if(idx >= 0) poolItems.splice(idx, 1);
      }
      pickedItems.push(...finalGroup);
      updateRemainingUI();
      if(poolItems.length === 0) setState('å·²åœæ­¢ï¼ˆæ± å·²æŠ½ç©ºï¼‰', 'ä¸æ”¾å›æ¨¡å¼ï¼šå‰©ä½™ 0ï¼Œå¯ç‚¹å‡»â€œæ¢å¤å…¨éƒ¨â€ç»§ç»­');
      else setState('å·²åœæ­¢', `ä¸æ”¾å›æ¨¡å¼ï¼šå·²ç§»é™¤æœ¬ç»„ç»“æœï¼Œå‰©ä½™ ${poolItems.length} ä¸ª`);

      // è‹¥å½“å‰é€‰æ‹©æ•°é‡å¤§äºå‰©ä½™æ± ï¼Œåœæ­¢åè‡ªåŠ¨ç¼©åˆ°å¯ç”¨èŒƒå›´ï¼ˆåªè°ƒæ•´ valueï¼Œä¸æ”¹å¯é€‰èŒƒå›´ï¼‰
      const sel = $('drawCount');
      const want = getDrawCount();
      if(poolItems.length > 0 && want > poolItems.length){
        sel.value = String(Math.max(1, poolItems.length));
      }
    }else{
      setState('å·²åœæ­¢', finalGroup.length ? 'æœ€ç»ˆç»“æœå·²ç”Ÿæˆï¼Œå¯å¤åˆ¶' : 'æ— å¯ç”¨å…ƒç´ ');
    }
  }

  function resetPool(){
    poolItems = masterItems.slice();
    pickedItems = [];
    updateRemainingUI();
    setState('å·²æ¢å¤æŠ½å–æ± ', isNoReplaceEnabled() ? 'ä¸æ”¾å›æ¨¡å¼ï¼šå·²æ¢å¤å…¨éƒ¨å…ƒç´ ' : 'æ”¾å›æ¨¡å¼æ— éœ€æ¢å¤');
  }

  function resetAll(){
    stopRolling();
    masterItems = []; poolItems = []; pickedItems = [];
    currentGroup = []; finalGroup = []; history = [];
    renderCurrentGroup([]);
    renderFinalGroup([]);
    $('finalHint').textContent = 'ç‚¹å‡»â€œåœæ­¢â€åç”Ÿæˆ';
    $('historyBox').textContent = 'â€”';
    $('previewList').textContent = 'â€”';
    $('textInput').value = '';
    $('csvRowFile').value = '';
    $('csvColFile').value = '';
    updateCount();
    setState('å¾…è§£æ', 'è¯·å…ˆè§£æè¾“å…¥');
  }

  async function parseAndDedup(){
    stopRolling();
    let items = [];
    try{
      if(mode === 'text'){
        items = parseElementsFromText($('textInput').value || '');
      }else if(mode === 'csvRow'){
        const file = $('csvRowFile').files[0];
        if(!file){ alert('è¯·å…ˆé€‰æ‹© CSV æ–‡ä»¶ã€‚'); return; }
        const enc = $('csvRowEncoding').value || 'utf-8';
        const ignore = $('csvRowIgnoreEmpty').value === 'yes';
        const txt = await readFileAsText(file, enc);
        items = parseCSVRowMode(txt, ignore);
      }else{
        const file = $('csvColFile').files[0];
        if(!file){ alert('è¯·å…ˆé€‰æ‹© CSV æ–‡ä»¶ã€‚'); return; }
        const enc = $('csvColEncoding').value || 'utf-8';
        const joiner = $('csvColJoiner').value ?? ' ';
        const txt = await readFileAsText(file, enc);
        items = parseCSVColumnMode(txt, joiner);
      }
    }catch(e){
      console.error(e);
      alert('è§£æå¤±è´¥ï¼š' + (e?.message || e));
      return;
    }

    const set = new Set();
    for(const it of items){ const t = norm(it); if(t) set.add(t); }
    masterItems = Array.from(set);
    poolItems = masterItems.slice();
    pickedItems = [];
    history = [];
    $('historyBox').textContent = 'â€”';

    updateCount();
    updatePreview();

    if(masterItems.length){
      setState('å·²è§£æ', `å·²è·å¾— ${masterItems.length} ä¸ªå»é‡å…ƒç´ ï¼Œå¯å¼€å§‹æŠ½å–`);
      currentGroup = computeCurrentGroup();
      renderCurrentGroup(currentGroup);
      pushHistory(currentGroup);
      renderFinalGroup([]);
      $('finalHint').textContent = 'ç‚¹å‡»â€œåœæ­¢â€åç”Ÿæˆ';
    }else{
      setState('è§£æç»“æœä¸ºç©º', 'è¯·æ£€æŸ¥è¾“å…¥æˆ–æ–‡ä»¶å†…å®¹');
      renderCurrentGroup([]);
      renderFinalGroup([]);
    }
  }

  function loadDemo(){
    setMode('text');
    $('textInput').value = 'å¼ ä¸‰,æå››,hello\\,world,ç‹äº”,å¼ ä¸‰,C\\\\C,åŒ…å«\\,é€—å·\\,çš„å…ƒç´ ,å†æ¥ä¸€ä¸ª';
    parseAndDedup();
  }

  // ======== äº‹ä»¶ç»‘å®š ========
  tabs.forEach(t => t.addEventListener('click', ()=>setMode(t.dataset.mode)));
  $('btnParse').addEventListener('click', parseAndDedup);
  $('btnClear').addEventListener('click', resetAll);
  $('btnLoadDemo').addEventListener('click', loadDemo);
  $('btnStart').addEventListener('click', startRolling);
  $('btnStop').addEventListener('click', stopRolling);
  $('btnResetPool').addEventListener('click', ()=>{ if(!masterItems.length){ alert('è¿˜æ²¡æœ‰è§£æä»»ä½•å…ƒç´ ï¼Œæ— æ³•æ¢å¤ã€‚'); return; } resetPool(); });
  $('noReplace').addEventListener('change', ()=>{
    if(isNoReplaceEnabled() && poolItems.length===0 && masterItems.length){ poolItems = masterItems.slice(); pickedItems = []; }
    updateRemainingUI();
    // è‹¥åˆ‡åˆ°ä¸æ”¾å›ä¸”å‰©ä½™å°äºå½“å‰æŠ½å–æ•°é‡ï¼Œè‡ªåŠ¨ç¼©å°
    const sel = $('drawCount');
    if(isNoReplaceEnabled() && poolItems.length>0 && getDrawCount()>poolItems.length){ sel.value = String(Math.max(1, poolItems.length)); }
  });

  $('drawCount').addEventListener('change', ()=>{
    // æ›´æ–°å½“å‰å±•ç¤º
    if(masterItems.length){
      currentGroup = computeCurrentGroup();
      renderCurrentGroup(currentGroup);
      pushHistory(currentGroup);
    }
  });

  $('btnCopy').addEventListener('click', async ()=>{
    const text = Array.isArray(finalGroup) && finalGroup.length ? finalGroup.join('\n') : '';
    if(!text){ alert('è¿˜æ²¡æœ‰æœ€ç»ˆç»“æœï¼šè¯·å…ˆå¼€å§‹å¹¶åœæ­¢ä¸€æ¬¡æŠ½å–ã€‚'); return; }
    try{ await navigator.clipboard.writeText(text); $('finalHint').textContent = 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ âœ…'; setTimeout(()=> $('finalHint').textContent = 'å·²åœæ­¢å¹¶å®šæ ¼å½“å‰å€¼', 1200); }
    catch{
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      $('finalHint').textContent = 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ âœ…';
      setTimeout(()=> $('finalHint').textContent = 'å·²åœæ­¢å¹¶å®šæ ¼å½“å‰å€¼', 1200);
    }
  });

  window.addEventListener('keydown', (e)=>{
    if(e.key === ' '){ e.preventDefault(); running ? stopRolling() : startRolling(); }
    else if(e.key.toLowerCase() === 'r'){ e.preventDefault(); stopRolling(); startRolling(); }
    else if(e.key === 'Escape'){ stopRolling(); }
  });

  // ======== Themeï¼ˆä¸é™„ä»¶ä¸€è‡´ï¼‰ ========
  (function initTheme(){
    const KEY = 'verdvana_theme';
    const html = document.documentElement;
    const toggle = document.getElementById('themeToggle');
    const label = document.getElementById('themeLabel');
    const wrap = document.getElementById('themeSwitchWrap');
    if(!toggle || !label || !wrap) return;

    const systemPrefersDark = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    function withTransition(fn){
      html.classList.add('theme-transition');
      try{ fn(); } finally{ window.setTimeout(()=> html.classList.remove('theme-transition'), 280); }
    }

    function apply(mode){
      if(mode === 'system'){
        html.removeAttribute('data-theme');
        toggle.checked = systemPrefersDark();
        label.textContent = 'ç³»ç»Ÿ';
      }else{
        html.setAttribute('data-theme', mode);
        toggle.checked = (mode === 'dark');
        label.textContent = (mode === 'dark') ? 'æ·±è‰²' : 'æµ…è‰²';
      }
      if(toggle.checked) wrap.classList.add('on');
      else wrap.classList.remove('on');
    }

    const getSaved = ()=> localStorage.getItem(KEY) || 'system';
    const save = (mode)=> localStorage.setItem(KEY, mode);

    apply(getSaved());

    const mql = window.matchMedia('(prefers-color-scheme: dark)');
    const onSystemChange = ()=>{ if(getSaved() === 'system') withTransition(()=>apply('system')); };
    if(mql && mql.addEventListener) mql.addEventListener('change', onSystemChange);
    else if(mql && mql.addListener) mql.addListener(onSystemChange);

    toggle.addEventListener('click', (e)=>{
      if(e.altKey){ save('system'); withTransition(()=>apply('system')); return; }
      const next = toggle.checked ? 'dark' : 'light';
      save(next);
      withTransition(()=>apply(next));
    });

    let pressTimer = null;
    wrap.addEventListener('pointerdown', ()=>{
      pressTimer = setTimeout(()=>{
        save('system');
        withTransition(()=>apply('system'));
        wrap.title = 'å·²åˆ‡å›ï¼šç³»ç»Ÿ';
        setTimeout(()=> wrap.title = 'åˆ‡æ¢æ˜æš—æ¨¡å¼ï¼ˆAlt/Option ç‚¹å‡»æˆ–é•¿æŒ‰å¯åˆ‡å›ç³»ç»Ÿï¼‰', 1200);
      }, 800);
    });
    wrap.addEventListener('pointerup', ()=>{ if(pressTimer) clearTimeout(pressTimer); });
    wrap.addEventListener('pointercancel', ()=>{ if(pressTimer) clearTimeout(pressTimer); });
  })();

  // ======== Sidebarï¼ˆä¸é™„ä»¶ä¸€è‡´ï¼‰ ========
  (function initSidebar(){
    const sb = document.getElementById('sidebar');
    const btn = document.getElementById('sbToggle');
    const back = document.getElementById('sbBack');
    const backdrop = document.getElementById('sbBackdrop');
    if(!sb || !btn) return;

    sb.classList.remove('is-expanded');
    const mq = window.matchMedia ? window.matchMedia('(max-width: 720px)') : null;
    const isMobile = () => mq ? mq.matches : (window.innerWidth <= 720);

    function setIcon(){
      const icon = btn.querySelector('i');
      if(!icon) return;
      icon.className = sb.classList.contains('is-expanded') ? 'fa-solid fa-chevron-left' : 'fa-solid fa-bars';
    }

    function syncOverlay(){
      const active = sb.classList.contains('is-expanded') && isMobile();
      if(backdrop) backdrop.classList.toggle('is-active', active);
      document.body.classList.toggle('sb-lock-scroll', active);
    }

    function collapse(){ sb.classList.remove('is-expanded'); setIcon(); syncOverlay(); }

    setIcon();
    syncOverlay();

    btn.addEventListener('click', ()=>{ sb.classList.toggle('is-expanded'); setIcon(); syncOverlay(); });

    if(backdrop){
      backdrop.addEventListener('click', collapse);
      backdrop.addEventListener('touchstart', collapse, {passive:true});
    }

    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && sb.classList.contains('is-expanded') && isMobile()) collapse(); });
    window.addEventListener('resize', syncOverlay);
    if(mq && mq.addEventListener) mq.addEventListener('change', syncOverlay);
    else if(mq && mq.addListener) mq.addListener(syncOverlay);

    if(back){
      back.addEventListener('click', ()=>{
        try{ if(history.length > 1){ history.back(); return; } }catch(e){}
        try{
          const u = new URL(window.location.href);
          let p = u.pathname.replace(/\/+$/, '');
          const idx = p.lastIndexOf('/');
          if(idx > 0){ u.pathname = p.slice(0, idx + 1); window.location.assign(u.toString()); return; }
        }catch(e){}
        window.location.assign('https://verdvana.cn/labs/');
      });
    }
  })();

  // init
  setMode('text');
  updateCount();
  renderCurrentGroup([]);
  renderFinalGroup([]);
</script>
</body>
</html>
