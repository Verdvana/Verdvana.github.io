
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æˆ¿è´·è®¡ç®—å™¨ï¼ˆå•†è´· / å…¬ç§¯é‡‘ / åˆ©ç‡å˜æ›´ / æå‰è¿˜æ¬¾ï¼‰</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --faint: rgba(255,255,255,0.45);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --accent: #7aa2ff;
      --accent2:#7df0c4;
      --danger:#ff6b6b;
      --ok:#39d98a;
      --warn:#ffd166;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel: rgba(0,0,0,0.04);
        --panel2: rgba(0,0,0,0.06);
        --text: rgba(0,0,0,0.9);
        --muted: rgba(0,0,0,0.62);
        --faint: rgba(0,0,0,0.42);
        --border: rgba(0,0,0,0.10);
        --shadow: 0 18px 50px rgba(8, 15, 35, 0.10);
        --accent:#2b6dff;
        --accent2:#00a37a;
      }
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% -20%, rgba(122,162,255,0.22), transparent 60%),
                  radial-gradient(900px 550px at 20% 0%, rgba(125,240,196,0.18), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
      line-height: 1.5;
    }
    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }
    .wrap{
      max-width: 1160px;
      margin: 0 auto;
      padding: 28px 18px 80px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 18px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width: 40px; height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(122,162,255,0.95), rgba(125,240,196,0.85));
      box-shadow: 0 10px 30px rgba(0,0,0,0.22);
    }
    h1{
      font-size: 18px;
      margin:0;
      letter-spacing: 0.2px;
    }
    .subtitle{
      margin:2px 0 0;
      color: var(--muted);
      font-size: 13px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.02);
      padding:8px 12px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd{
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .card .hd h2{
      font-size: 14px;
      margin:0;
      letter-spacing: 0.2px;
    }
    .card .bd{ padding: 16px 18px; }
    .section-title{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(122,162,255,0.18);
    }
    .dot.green{
      background: var(--accent2);
      box-shadow: 0 0 0 4px rgba(125,240,196,0.16);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    @media (max-width: 640px){
      .row{ grid-template-columns: 1fr; }
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select, button, textarea{
      font-family: var(--sans);
    }
    input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      background: rgba(255,255,255,0.03);
      color: var(--text);
    }
    input::placeholder{ color: var(--faint); }
    input:focus, select:focus{
      border-color: rgba(122,162,255,0.6);
      box-shadow: 0 0 0 4px rgba(122,162,255,0.14);
    }
    .hint{
      font-size: 12px;
      color: var(--faint);
      margin-top: 6px;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 10px;
    }
    button{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .04s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{
      background: rgba(255,255,255,0.07);
      border-color: rgba(122,162,255,0.55);
    }
    button:active{ transform: translateY(1px); }
    .primary{
      background: linear-gradient(135deg, rgba(122,162,255,0.95), rgba(125,240,196,0.75));
      border: none;
      color: rgba(0,0,0,0.78);
      font-weight: 650;
    }
    .primary:hover{ filter: brightness(1.02); }
    .danger{
      border-color: rgba(255,107,107,0.45);
      color: rgba(255,107,107,0.92);
    }
    .danger:hover{ background: rgba(255,107,107,0.08); }
    .table{
      width:100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      margin-top: 10px;
    }
    .table th, .table td{
      padding: 9px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      vertical-align: middle;
    }
    .table th{
      color: var(--muted);
      font-weight: 600;
      text-align: left;
      background: rgba(255,255,255,0.04);
    }
    .table tr:last-child td{ border-bottom: none; }
    .td-actions{
      display:flex; gap:8px; align-items:center;
    }
    .mini{
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 12px;
    }
    .muted{ color: var(--muted); }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 640px){
      .kpi{ grid-template-columns: 1fr; }
    }
    .kpi .box{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.03);
    }
    .kpi .box .t{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .box .v{ font-size: 16px; font-weight: 700; letter-spacing: .2px; }
    .kpi .box .s{ font-size: 12px; color: var(--faint); margin-top: 4px; }
    .split{
      height:1px; background: var(--border); margin: 14px 0;
    }
    details{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.02);
      padding: 10px 12px;
    }
    summary{
      cursor:pointer;
      color: var(--muted);
      font-size: 13px;
      user-select:none;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }
    .code{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,0.02);
    }
    .badge .b{ width:7px;height:7px;border-radius:99px;background: var(--ok); }
    .badge.warn .b{ background: var(--warn); }
    .badge.danger .b{ background: var(--danger); }
    .footer-note{
      margin-top: 14px;
      font-size: 12px;
      color: var(--faint);
    }

    /* ====== Theme override: manual light/dark ====== */
    html[data-theme="dark"]{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --faint: rgba(255,255,255,0.45);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --accent: #7aa2ff;
      --accent2:#7df0c4;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --panel: rgba(0,0,0,0.04);
      --panel2: rgba(0,0,0,0.06);
      --text: rgba(0,0,0,0.9);
      --muted: rgba(0,0,0,0.62);
      --faint: rgba(0,0,0,0.42);
      --border: rgba(0,0,0,0.10);
      --shadow: 0 18px 50px rgba(8, 15, 35, 0.10);
      --accent:#2b6dff;
      --accent2:#00a37a;
    }

    /* ====== Smooth theme transition (avoid affecting input experience) ====== */
    html.theme-transition,
    html.theme-transition body{
      transition: background-color .25s ease, color .25s ease;
    }
    html.theme-transition *:not(input):not(textarea):not(select),
    html.theme-transition *:not(input):not(textarea):not(select)::before,
    html.theme-transition *:not(input):not(textarea):not(select)::after{
      transition:
        background-color .25s ease,
        color .25s ease,
        border-color .25s ease,
        box-shadow .25s ease,
        fill .25s ease,
        stroke .25s ease,
        opacity .25s ease;
    }
    html.theme-transition input,
    html.theme-transition textarea,
    html.theme-transition select{
      transition: none !important;
    }

    /* ====== iOS-like theme switch ====== */
    .theme-switch{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .theme-switch .label{
      font-size:12px;
      color: var(--muted);
    }
    .switch{
      position: relative;
      width: 44px;
      height: 26px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid var(--border);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02);
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    @media (prefers-color-scheme: light){
      .switch{ background: rgba(0,0,0,0.06); }
    }
    .switch input{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }
    .switch .knob{
      position:absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 6px 16px rgba(0,0,0,0.22);
      transform: translateX(0);
      transition: transform .2s ease, background .2s ease;
    }
    html[data-theme="light"] .switch .knob{
      background: rgba(255,255,255,0.98);
    }
    .switch input:checked ~ .knob{
      transform: translateX(18px);
    }
    .switch.on{
      background: rgba(125,240,196,0.22);
      border-color: rgba(125,240,196,0.35);
    }
    .switch:focus-within{
      box-shadow: 0 0 0 4px rgba(122,162,255,0.16);
    }

      

/* ====== Left sidebar (OpenAI-like) + overlay ====== */
.layout{
  display:flex;
  min-height: 100vh;
}
.sidebar{
  --sb-w: 64px; /* collapsed width */
  width: var(--sb-w);
  flex: 0 0 var(--sb-w);
  height: 100vh;
  position: sticky;
  top: 0;
  z-index: 9998;
  border-right: 1px solid var(--border);
  background: rgba(255,255,255,0.04);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display:flex;
  flex-direction: column;
  padding: 10px 10px;
  gap: 10px;
  transition: width .18s ease, flex-basis .18s ease;
}
html[data-theme="light"] .sidebar{
  background: rgba(255,255,255,0.72);
}
.sidebar.is-expanded{ --sb-w: 252px; }
.main{ flex: 1 1 auto; min-width: 0; }

.sb-top{ display:flex; align-items:center; gap: 10px; }
.sb-toggle{
  width: 40px; height: 40px;
  border-radius: 12px;
  padding: 0;
  display:grid; place-items:center;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.03);
}
.sb-toggle:hover{ background: rgba(255,255,255,0.07); border-color: rgba(122,162,255,0.55); }
.sb-toggle i{ font-size: 16px; }

.sb-logo{
  width: 40px; height: 40px;
  border-radius: 14px;
  overflow:hidden;
  border: 1px solid var(--border);
  flex: 0 0 auto;
  display:block;
}
.sb-logo img{ width:100%; height:100%; object-fit: cover; display:block; }

.sb-nav{ display:flex; flex-direction: column; gap: 6px; padding-top: 6px; }
.sb-item{
  display:flex; align-items:center; gap: 12px;
  width: 100%;
  border-radius: 12px;
  padding: 10px 10px;
  border: 1px solid transparent;
  color: var(--text);
  background: transparent;
  text-decoration: none;
  cursor: pointer;
  user-select: none;
  transition: background .16s ease, border-color .16s ease, transform .04s ease;
}
.sb-item:hover{ background: rgba(255,255,255,0.06); border-color: rgba(122,162,255,0.25); }
.sb-item:active{ transform: translateY(1px); }
.sb-item i{ width: 20px; text-align:center; opacity: 0.92; }
.sb-item span{ white-space: nowrap; font-size: 13px; color: var(--text); }

.sidebar:not(.is-expanded) .sb-item span{ display:none; }
.sidebar:not(.is-expanded) .sb-top{ flex-direction: column; align-items: stretch; justify-content: flex-start; }
.sidebar:not(.is-expanded) .sb-logo{ display:block; }

.sb-sep{ height: 1px; background: var(--border); margin: 6px 2px; }
.sb-bottom{ margin-top: auto; padding-top: 6px; }
.sb-back{ border: 1px solid var(--border); background: rgba(255,255,255,0.03); }
.sb-back:hover{ border-color: rgba(255,209,102,0.35); background: rgba(255,209,102,0.10); }

/* Backdrop overlay (mobile when expanded) */
.sb-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  opacity: 0;
  pointer-events: none;
  transition: opacity .16s ease;
  z-index: 9997;
}
.sb-backdrop.is-active{ opacity: 1; pointer-events: auto; }

/* Mobile: sidebar overlays content when expanded */
@media (max-width: 720px){
  .sidebar{ position: fixed; left: 0; top: 0; }
  .main{ margin-left: 64px; }
  .sidebar.is-expanded{ box-shadow: 0 18px 60px rgba(0,0,0,0.35); }
  body.sb-lock-scroll{ overflow: hidden; }
}

@media print{
  .sidebar, .sb-backdrop{ display:none; }
  .main{ margin-left: 0; }
}

</style>
</head>
<body>

<div class="layout" id="appLayout">
  <aside class="sidebar" id="sidebar" aria-label="ç«™ç‚¹å¯¼èˆª">
    <div class="sb-top">
      <button class="sb-toggle" id="sbToggle" type="button" aria-label="å±•å¼€/æŠ˜å èœå•" title="å±•å¼€/æŠ˜å èœå•">
        <i class="fa-solid fa-bars" aria-hidden="true"></i>
      </button>
      <a class="sb-logo" href="https://verdvana.cn" title="verdvana.cn">
        <img src="https://verdvana.cn/static/img/avatar.jpg" alt="logo" />
      </a>
    </div>

    <nav class="sb-nav" aria-label="å¿«æ·å…¥å£">
      <a class="sb-item" href="https://verdvana.cn" title="ä¸»é¡µ">
        <i class="fa-solid fa-home" aria-hidden="true"></i><span>ä¸»é¡µ</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/archive/" title="åšæ–‡">
        <i class="fa-solid fa-archive" aria-hidden="true"></i><span>åšæ–‡</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/tags/" title="åˆ†ç±»">
        <i class="fa-solid fa-tags" aria-hidden="true"></i><span>åˆ†ç±»</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/comments/" title="ç•™è¨€">
        <i class="fa-solid fa-comments" aria-hidden="true"></i><span>ç•™è¨€</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/merger/" title="æ‰“èµ">
        <i class="fa-solid fa-coffee" aria-hidden="true"></i><span>æ‰“èµ</span>
      </a>
      <a class="sb-item" href="https://verdvana.cn/labs/" title="æ›´å¤š">
        <i class="fa-solid fa-flask" aria-hidden="true"></i><span>æ›´å¤š</span>
      </a>
      <div class="sb-sep" role="separator" aria-hidden="true"></div>
    </nav>

    <div class="sb-bottom">
      <button class="sb-item sb-back" id="sbBack" type="button" title="è¿”å›ä¸Šä¸€çº§">
        <i class="fa-solid fa-arrow-left" aria-hidden="true"></i><span>è¿”å›ä¸Šä¸€çº§</span>
      </button>
    </div>
  </aside>

  <div class="sb-backdrop" id="sbBackdrop" aria-hidden="true"></div>

  <main class="main" id="mainContent">

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>æˆ¿è´·è®¡ç®—å™¨ï¼ˆæ”¯æŒåˆ©ç‡å˜æ›´ & æå‰è¿˜æ¬¾ï¼‰</h1>
        <div class="subtitle">å•†è´· / å…¬ç§¯é‡‘ Â· ç­‰é¢æœ¬æ¯ / ç­‰é¢æœ¬é‡‘ Â· å¤šæ¬¡åˆ©ç‡æ›´æ–° Â· æå‰è¿˜æ¬¾ï¼ˆç¼©çŸ­å¹´é™ / å‡å°‘æœˆä¾›ï¼‰</div>
      </div>
    </div>

    <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
      <div class="theme-switch">
        <span class="label" id="themeLabel">ç³»ç»Ÿ</span>
        <div class="switch" id="themeSwitchWrap" title="åˆ‡æ¢æ˜æš—æ¨¡å¼ï¼ˆAlt/Option ç‚¹å‡»æˆ–é•¿æŒ‰å¯åˆ‡å›ç³»ç»Ÿï¼‰">
          <input id="themeToggle" type="checkbox" aria-label="åˆ‡æ¢æ˜æš—æ¨¡å¼">
          <span class="knob" aria-hidden="true"></span>
        </div>
      </div>

      <div class="pill">
        <span>ğŸ“Œ</span>
        <span>è§„åˆ™å¯æŒ‰ä½ çš„é“¶è¡Œå£å¾„è°ƒæ•´</span>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- å·¦ä¾§ï¼šè¾“å…¥ -->
    <div class="card">
      <div class="hd">
        <div class="section-title">
          <div class="dot"></div>
          <h2>è¾“å…¥å‚æ•°</h2>
        </div>
        <div class="badge warn"><span class="b"></span><span>åˆ©ç‡å•ä½ï¼šå¹´åŒ– %</span></div>
      </div>
      <div class="bd">

        <!-- å•†ä¸šè´·æ¬¾ -->
        <div class="card" style="box-shadow:none;">
          <div class="hd">
            <div class="section-title">
              <div class="dot"></div>
              <h2>å•†ä¸šè´·æ¬¾</h2>
            </div>
            <div class="badge"><span class="b"></span><span>å¯ç•™ç©ºï¼ˆé‡‘é¢=0ï¼‰</span></div>
          </div>
          <div class="bd">
            <div class="row">
              <div>
                <label>è´·æ¬¾èµ·å§‹å¹´æœˆ</label>
                <input id="bizStart" type="month" value="2026-01" />
                <div class="hint">ç”¨äºåŒ¹é…åˆ©ç‡å˜æ›´ä¸æå‰è¿˜æ¬¾æ—¥æœŸï¼ˆæŒ‰â€œå¹´æœˆâ€è®¡ç®—ï¼‰ã€‚</div>
              </div>
              <div>
                <label>è´·æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <input id="bizAmount" type="number" min="0" step="1000" placeholder="ä¾‹å¦‚ï¼š1000000" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>èµ·å§‹å¹´åŒ–åˆ©ç‡ï¼ˆ%ï¼‰</label>
                <input id="bizRate" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š4.10" />
              </div>
              <div>
                <label>è´·æ¬¾å¹´é™ï¼ˆå¹´ï¼‰</label>
                <input id="bizYears" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š30" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>è¿˜æ¬¾æ–¹å¼</label>
                <select id="bizMethod">
                  <option value="annuity">ç­‰é¢æœ¬æ¯</option>
                  <option value="equalPrincipal">ç­‰é¢æœ¬é‡‘</option>
                </select>
              </div>
              <div>
                <label>ï¼ˆå¯é€‰ï¼‰å¤‡æ³¨</label>
                <input id="bizNote" type="text" placeholder="ä¾‹å¦‚ï¼šé¦–å¥—ã€LPR+bp ç­‰" />
              </div>
            </div>

            <div class="toolbar">
              <button class="mini" onclick="addRateRow('biz')">+ æ·»åŠ åˆ©ç‡æ›´æ–°èŠ‚ç‚¹</button>
              <button class="mini danger" onclick="clearRateRows('biz')">æ¸…ç©ºèŠ‚ç‚¹</button>
            </div>

            <table class="table" id="bizRateTable">
              <thead>
                <tr>
                  <th style="width: 40%;">ç”Ÿæ•ˆå¹´æœˆ</th>
                  <th style="width: 40%;">å¹´åŒ–åˆ©ç‡ï¼ˆ%ï¼‰</th>
                  <th style="width: 20%;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="small">æç¤ºï¼šåˆ©ç‡èŠ‚ç‚¹ä¼šæŒ‰æ—¶é—´æ’åºï¼›åŒæœˆå¤šæ¡å°†å–æœ€åä¸€æ¡ã€‚</div>
          </div>
        </div>

        <div class="split"></div>

        <!-- å…¬ç§¯é‡‘è´·æ¬¾ -->
        <div class="card" style="box-shadow:none;">
          <div class="hd">
            <div class="section-title">
              <div class="dot green"></div>
              <h2>å…¬ç§¯é‡‘è´·æ¬¾</h2>
            </div>
            <div class="badge"><span class="b"></span><span>å¯ç•™ç©ºï¼ˆé‡‘é¢=0ï¼‰</span></div>
          </div>
          <div class="bd">
            <div class="row">
              <div>
                <label>è´·æ¬¾èµ·å§‹å¹´æœˆ</label>
                <input id="gjjStart" type="month" value="2026-01" />
              </div>
              <div>
                <label>è´·æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <input id="gjjAmount" type="number" min="0" step="1000" placeholder="ä¾‹å¦‚ï¼š600000" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>èµ·å§‹å¹´åŒ–åˆ©ç‡ï¼ˆ%ï¼‰</label>
                <input id="gjjRate" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š3.10" />
              </div>
              <div>
                <label>è´·æ¬¾å¹´é™ï¼ˆå¹´ï¼‰</label>
                <input id="gjjYears" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š30" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>è¿˜æ¬¾æ–¹å¼</label>
                <select id="gjjMethod">
                  <option value="annuity">ç­‰é¢æœ¬æ¯</option>
                  <option value="equalPrincipal">ç­‰é¢æœ¬é‡‘</option>
                </select>
              </div>
              <div>
                <label>ï¼ˆå¯é€‰ï¼‰å¤‡æ³¨</label>
                <input id="gjjNote" type="text" placeholder="ä¾‹å¦‚ï¼šå…¬ç§¯é‡‘é¦–å¥—" />
              </div>
            </div>

            <div class="toolbar">
              <button class="mini" onclick="addRateRow('gjj')">+ æ·»åŠ åˆ©ç‡æ›´æ–°èŠ‚ç‚¹</button>
              <button class="mini danger" onclick="clearRateRows('gjj')">æ¸…ç©ºèŠ‚ç‚¹</button>
            </div>

            <table class="table" id="gjjRateTable">
              <thead>
                <tr>
                  <th style="width: 40%;">ç”Ÿæ•ˆå¹´æœˆ</th>
                  <th style="width: 40%;">å¹´åŒ–åˆ©ç‡ï¼ˆ%ï¼‰</th>
                  <th style="width: 20%;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="small">æç¤ºï¼šå…¬ç§¯é‡‘åˆ©ç‡ä¹Ÿå¯é…ç½®å¤šæ¬¡è°ƒæ•´ï¼ˆå¦‚æ”¿ç­–å˜åŠ¨ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="split"></div>

        <!-- æå‰è¿˜æ¬¾ -->
        <div class="card" style="box-shadow:none;">
          <div class="hd">
            <div class="section-title">
              <div class="dot" style="background:#ffd166; box-shadow: 0 0 0 4px rgba(255,209,102,0.18);"></div>
              <h2>æå‰è¿˜æ¬¾ï¼ˆå¯é€‰ï¼‰</h2>
            </div>
            <div class="badge warn"><span class="b"></span><span>ä¸å¡«åˆ™ä¸è®¡ç®—æå‰è¿˜æ¬¾</span></div>
          </div>
          <div class="bd">
            <div class="row">
              <div>
                <label>æå‰è¿˜æ¬¾å¹´æœˆ</label>
                <input id="prepayDate" type="month" />
                <div class="hint">å‘ç”Ÿåœ¨å½“æœŸâ€œæ­£å¸¸è¿˜æ¬¾åâ€å†å†²æŠµæœ¬é‡‘ã€‚</div>
              </div>
              <div>
                <label>æå‰è¿˜æ¬¾é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <input id="prepayAmount" type="number" min="0" step="1000" placeholder="ä¾‹å¦‚ï¼š200000" />
              </div>
            </div>
            <div class="row">
              <div>
                <label>åˆ†é…æ–¹å¼</label>
                <select id="prepayAlloc">
                  <option value="bizFirst">ä¼˜å…ˆå†²å•†è´·</option>
                  <option value="gjjFirst">ä¼˜å…ˆå†²å…¬ç§¯é‡‘</option>
                  <option value="proRata">æŒ‰å‰©ä½™æœ¬é‡‘æ¯”ä¾‹åˆ†æ‘Š</option>
                </select>
              </div>
              <div>
                <label>æå‰è¿˜æ¬¾ç­–ç•¥</label>
                <select id="prepayMode">
                  <option value="shortenTerm">ç¼©çŸ­å¹´é™ï¼ˆä¿æŒæœˆä¾›å°½é‡ä¸å˜ï¼‰</option>
                  <option value="reducePayment">å‡å°‘æœˆä¾›ï¼ˆä¿æŒæœŸé™å°½é‡ä¸å˜ï¼‰</option>
                </select>
              </div>
            </div>

            <div class="toolbar">
              <button class="primary" onclick="calculateAll()">å¼€å§‹è®¡ç®—</button>
              <button onclick="fillDemo()">å¡«å…¥ç¤ºä¾‹æ•°æ®</button>
              <button onclick="downloadCSV()">ä¸‹è½½è¿˜æ¬¾æ˜ç»† CSV</button>
            </div>

            <div class="footer-note">
              è®¡ç®—ç»“æœä¸ºæ¨¡æ‹Ÿä¼°ç®—ï¼Œå®é™…ä»¥é“¶è¡Œæ‰£æ¬¾/è®¡æ¯è§„åˆ™ä¸ºå‡†ã€‚éœ€è¦æŒ‰ä½ çš„é“¶è¡Œâ€œé‡å®šä»·æ—¥ / æ‰£æ¬¾æ—¥è§„åˆ™â€å®šåˆ¶çš„è¯å‘Šè¯‰æˆ‘ã€‚
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- å³ä¾§ï¼šç»“æœ -->
    <div class="card">
      <div class="hd">
        <div class="section-title">
          <div class="dot" style="background:#39d98a; box-shadow:0 0 0 4px rgba(57,217,138,0.16);"></div>
          <h2>è®¡ç®—ç»“æœ</h2>
        </div>
        <div class="badge"><span class="b"></span><span>å«åˆ©ç‡å˜æ›´ & æå‰è¿˜æ¬¾å¯¹æ¯”</span></div>
      </div>
      <div class="bd">
        <div class="kpi" id="kpiTop">
          <div class="box">
            <div class="t">åˆè®¡é¦–æœˆæœˆä¾›ï¼ˆåŸºå‡†/æ— æå‰è¿˜æ¬¾ï¼‰</div>
            <div class="v" id="kpiBasePay">â€”</div>
            <div class="s" id="kpiBasePayS">â€”</div>
          </div>
          <div class="box">
            <div class="t">åˆè®¡æ€»åˆ©æ¯ï¼ˆåŸºå‡†/æ— æå‰è¿˜æ¬¾ï¼‰</div>
            <div class="v" id="kpiBaseInt">â€”</div>
            <div class="s" id="kpiBaseIntS">â€”</div>
          </div>
          <div class="box">
            <div class="t">åˆè®¡é¦–æœˆæœˆä¾›ï¼ˆå«æå‰è¿˜æ¬¾ï¼‰</div>
            <div class="v" id="kpiAfterPay">â€”</div>
            <div class="s" id="kpiAfterPayS">â€”</div>
          </div>
          <div class="box">
            <div class="t">åˆè®¡æ€»åˆ©æ¯ï¼ˆå«æå‰è¿˜æ¬¾ï¼‰</div>
            <div class="v" id="kpiAfterInt">â€”</div>
            <div class="s" id="kpiAfterIntS">â€”</div>
          </div>
        </div>

        <div class="split"></div>

        <div id="summaryBlocks"></div>

        <div class="split"></div>

        <details>
          <summary>æŸ¥çœ‹ï¼šè®¡ç®—å‡è®¾ä¸è¯´æ˜ï¼ˆç‚¹å¼€ï¼‰</summary>
          <div class="small" style="margin-top:10px;">
            <ul>
              <li>æ¯æœˆæŒ‰ <span class="code">æœˆåˆ©ç‡ = å¹´åˆ©ç‡ / 12</span> è®¡æ¯ã€‚</li>
              <li>åˆ©ç‡æ›´æ–°èŠ‚ç‚¹ä»¥â€œç”Ÿæ•ˆå¹´æœˆâ€ä¸ºå‡†ï¼Œä»è¯¥æœˆå¼€å§‹åº”ç”¨ã€‚</li>
              <li>æå‰è¿˜æ¬¾å‘ç”Ÿåœ¨å½“æœˆâ€œæ­£å¸¸è¿˜æ¬¾åâ€ï¼Œç„¶åå†²æŠµæœ¬é‡‘ï¼ˆè‹¥é‡‘é¢è¶…è¿‡å‰©ä½™æœ¬é‡‘åˆ™æŒ‰å‰©ä½™æœ¬é‡‘è®¡ï¼‰ã€‚</li>
              <li>ç­‰é¢æœ¬æ¯ï¼š
                <ul>
                  <li>è‹¥é€‰æ‹©â€œå‡å°‘æœˆä¾›â€ï¼šé¢„è¿˜åæŒ‰å‰©ä½™æœŸæ•°é‡æ–°è®¡ç®—æœˆä¾›ï¼›åˆ©ç‡å˜åŒ–ä¹Ÿä¼šé‡æ–°è®¡ç®—æœˆä¾›ã€‚</li>
                  <li>è‹¥é€‰æ‹©â€œç¼©çŸ­å¹´é™â€ï¼šé¢„è¿˜åä¿æŒå½“æœŸæœˆä¾›ä¸å˜ï¼ŒæŒ‰æœˆæ¨¡æ‹Ÿç›´åˆ°ç»“æ¸…ï¼ˆåˆ©ç‡å˜åŒ–ä»…æ”¹å˜åˆ©æ¯/æœ¬é‡‘ç»“æ„ï¼Œä¸æ”¹å˜æœˆä¾›ï¼‰ã€‚</li>
                </ul>
              </li>
              <li>ç­‰é¢æœ¬é‡‘ï¼š
                <ul>
                  <li>é»˜è®¤æ¯æœˆå›ºå®šå½’è¿˜æœ¬é‡‘ï¼›åˆ©ç‡å˜åŒ–åªå½±å“å½“æœŸåˆ©æ¯ã€‚</li>
                  <li>â€œå‡å°‘æœˆä¾›â€ä¼šåœ¨é¢„è¿˜åç”¨ <span class="code">å‰©ä½™æœ¬é‡‘ / å‰©ä½™æœŸæ•°</span> é‡æ–°ç¡®å®šæ¯æœˆæœ¬é‡‘ã€‚</li>
                  <li>â€œç¼©çŸ­å¹´é™â€ä¼šä¿æŒæ¯æœˆæœ¬é‡‘ä¸å˜ï¼Œç»“æ¸…æœˆä»½è‡ªåŠ¨æå‰ã€‚</li>
                </ul>
              </li>
            </ul>
          </div>
        </details>

        <div class="split"></div>

        <details>
          <summary>æŸ¥çœ‹ï¼šæœ€è¿‘ä¸€æ¬¡è®¡ç®—çš„è°ƒè¯•è¾“å‡ºï¼ˆç‚¹å¼€ï¼‰</summary>
          <div class="code" id="debugOut">â€”</div>
        </details>
      </div>
    </div>

  </div>
</div>

<script>
  // ======== å·¥å…·å‡½æ•°ï¼šé‡‘é¢/æ—¥æœŸ/æ ¼å¼ ========
  const fmtMoney = (x) => {
    if (!isFinite(x)) return "â€”";
    return x.toLocaleString("zh-CN", {minimumFractionDigits: 2, maximumFractionDigits: 2});
  };
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

  function parseMonth(str){
    // "YYYY-MM" -> {y,m} , m:1-12
    if(!str || !/^\d{4}-\d{2}$/.test(str)) return null;
    const [y, mm] = str.split("-").map(Number);
    if(mm<1 || mm>12) return null;
    return {y, m:mm};
  }
  function monthToStr(ym){
    const mm = String(ym.m).padStart(2,"0");
    return `${ym.y}-${mm}`;
  }
  function addMonths(ym, delta){
    let y=ym.y, m=ym.m + delta;
    while(m>12){ m-=12; y++; }
    while(m<1){ m+=12; y--; }
    return {y,m};
  }
  function monthsDiff(a,b){
    // b - a
    return (b.y - a.y)*12 + (b.m - a.m);
  }
  function compareYM(a,b){
    const da = a.y*12 + a.m;
    const db = b.y*12 + b.m;
    return da - db;
  }

  // ======== åˆ©ç‡è¡¨ï¼šDOM ç®¡ç† ========
  function addRateRow(prefix, preset=null){
    const tbody = document.querySelector(`#${prefix}RateTable tbody`);
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    const inpDate = document.createElement("input");
    inpDate.type = "month";
    inpDate.value = preset?.date ?? "";
    td1.appendChild(inpDate);

    const td2 = document.createElement("td");
    const inpRate = document.createElement("input");
    inpRate.type = "number";
    inpRate.min = "0";
    inpRate.step = "0.01";
    inpRate.placeholder = "ä¾‹å¦‚ï¼š4.20";
    inpRate.value = preset?.rate ?? "";
    td2.appendChild(inpRate);

    const td3 = document.createElement("td");
    const actions = document.createElement("div");
    actions.className = "td-actions";
    const btnDel = document.createElement("button");
    btnDel.className = "mini danger";
    btnDel.textContent = "åˆ é™¤";
    btnDel.onclick = () => tr.remove();
    actions.appendChild(btnDel);
    td3.appendChild(actions);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tbody.appendChild(tr);
  }

  function clearRateRows(prefix){
    const tbody = document.querySelector(`#${prefix}RateTable tbody`);
    tbody.innerHTML = "";
  }

  function readRateRows(prefix){
    const tbody = document.querySelector(`#${prefix}RateTable tbody`);
    const rows = [...tbody.querySelectorAll("tr")];
    const out = [];
    for(const tr of rows){
      const inputs = tr.querySelectorAll("input");
      const d = parseMonth(inputs[0].value);
      const r = Number(inputs[1].value);
      if(!d || !isFinite(r) || r<=0) continue;
      out.push({date: d, annualRate: r/100});
    }
    // æ’åºï¼›åŒæœˆå–æœ€å
    out.sort((a,b)=>compareYM(a.date,b.date));
    const dedup = [];
    for(const it of out){
      const last = dedup[dedup.length-1];
      if(last && compareYM(last.date,it.date)===0){
        last.annualRate = it.annualRate;
      }else{
        dedup.push({...it});
      }
    }
    return dedup;
  }

  // ======== æ ¸å¿ƒï¼šè¿˜æ¬¾æ¨¡æ‹Ÿ ========
  function annuityPayment(balance, annualRate, months){
    if(months<=0) return 0;
    const r = annualRate/12;
    if(Math.abs(r) < 1e-12) return balance / months;
    const a = Math.pow(1+r, months);
    return balance * r * a / (a - 1);
  }

  function buildRateLookup(initialAnnualRate, rateChanges){
    // è¿”å›å‡½æ•° getRate(ym) -> annualRate
    const sorted = [...rateChanges].sort((a,b)=>compareYM(a.date,b.date));
    return (ym) => {
      let rate = initialAnnualRate;
      for(const ch of sorted){
        if(compareYM(ch.date, ym) <= 0) rate = ch.annualRate;
        else break;
      }
      return rate;
    };
  }

  function simulateLoan(params){
    // params:
    // {principal, startYM, totalMonths, method, initialAnnualRate, rateChanges[], prepay:{ym, amount, mode} or null, keepTermWhenNoPrepay:true}
    const {
      principal, startYM, totalMonths, method,
      initialAnnualRate, rateChanges,
      prepay
    } = params;

    const getRate = buildRateLookup(initialAnnualRate, rateChanges);

    let bal = principal;
    let ym = {...startYM};
    let monthIndex = 0;
    let totalInterest = 0;
    let totalPayment = 0;

    // è®¡åˆ’çŠ¶æ€
    let remainingMonthsPlan = totalMonths; // å¯¹ reducePayment æ¨¡å¼ï¼Œå›ºå®šæ€»æœŸæ•°ï¼›å¯¹ shortenTerm åªæ˜¯åˆå§‹å‚è€ƒ
    let payment = 0;
    let principalFixed = 0; // ç­‰é¢æœ¬é‡‘æ¯æœˆæœ¬é‡‘

    // åˆå§‹åŒ–
    if(method === "annuity"){
      payment = annuityPayment(bal, getRate(ym), remainingMonthsPlan);
    }else{
      principalFixed = (remainingMonthsPlan>0)? (bal / remainingMonthsPlan) : 0;
    }

    const schedule = [];
    let prepayApplied = false;

    // è¾…åŠ©ï¼šå½“åˆ©ç‡å˜åŒ–æ—¶ï¼Œæ˜¯å¦é‡ç®—æœˆä¾›ï¼ˆç­‰é¢æœ¬æ¯ï¼‰
    const recalcOnRateChange = () => {
      if(method !== "annuity") return;
      if(prepay && prepay.mode === "shortenTerm" && prepayApplied){
        // ç¼©çŸ­å¹´é™ï¼šä¿æŒæœˆä¾›ä¸å˜
        return;
      }
      // å…¶ä»–æƒ…å†µï¼šé‡ç®—
      payment = annuityPayment(bal, getRate(ym), remainingMonthsPlan);
    };

    // ç”¨äºåˆ¤æ–­åˆ©ç‡å˜åŒ–ç‚¹ï¼šç®€å•ç­–ç•¥ï¼Œé€æœˆæ¯”è¾ƒä¸Šæœˆåˆ©ç‡
    let lastRate = getRate(ym);

    // ä¸»å¾ªç¯ï¼šæœ€å¤šè·‘ totalMonths*2 é¿å…å¼‚å¸¸æ­»å¾ªç¯
    const maxIter = Math.max(12, totalMonths*2 + 120);

    while(bal > 1e-6 && monthIndex < maxIter){
      const annualRate = getRate(ym);
      if(Math.abs(annualRate - lastRate) > 1e-12){
        recalcOnRateChange();
        lastRate = annualRate;
      }

      const r = annualRate/12;
      let interest = bal * r;
      let principalPay = 0;
      let pay = 0;

      if(method === "annuity"){
        pay = payment;
        principalPay = pay - interest;
        if(principalPay < 0){
          // æç«¯æƒ…å†µä¸‹ï¼ˆé«˜åˆ©ç‡+ä½æœˆä¾›ï¼‰å¯èƒ½å‡ºç°è´Ÿæ‘Šè¿˜ï¼Œå¼ºè¡Œå°†æœˆä¾›æé«˜åˆ°è‡³å°‘è¦†ç›–åˆ©æ¯
          pay = interest + Math.max(1, bal*0.00001);
          principalPay = pay - interest;
        }
      }else{
        principalPay = principalFixed;
        pay = principalPay + interest;
      }

      // æœ€åä¸€æœŸæ”¶å°¾
      if(principalPay > bal){
        principalPay = bal;
        pay = principalPay + interest;
      }

      bal -= principalPay;
      totalInterest += interest;
      totalPayment += pay;

      schedule.push({
        ym: {...ym},
        rate: annualRate,
        payment: pay,
        interest,
        principal: principalPay,
        balance: bal < 1e-10 ? 0 : bal,
        extra: 0
      });

      // æœ¬æœˆæ­£å¸¸è¿˜æ¬¾åï¼šæ£€æŸ¥æ˜¯å¦æå‰è¿˜æ¬¾
      if(prepay && !prepayApplied && compareYM(ym, prepay.ym) === 0){
        const extra = clamp(prepay.amount, 0, bal);
        bal -= extra;
        prepayApplied = true;
        schedule[schedule.length-1].extra = extra;
        schedule[schedule.length-1].balance = bal < 1e-10 ? 0 : bal;

        // æå‰è¿˜æ¬¾åï¼Œæ›´æ–°è®¡åˆ’
        if(method === "annuity"){
          if(prepay.mode === "reducePayment"){
            // ä¿æŒå‰©ä½™æœŸæ•°ä¸å˜ï¼šremainingMonthsPlan å‡ 1ï¼ˆåˆšè¿˜å®Œæœ¬æœˆï¼‰åé‡æ–°ç®—
            // remainingMonthsPlan ä¼šåœ¨ä¸‹é¢ç»Ÿä¸€å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œä¸åŠ¨ï¼Œç­‰æ›´æ–°åé‡ç®—
          }else{
            // shortenTerm: ä¿æŒpaymentä¸å˜ï¼ˆå·²ç”±é€»è¾‘å¤„ç†ï¼‰
          }
        }else{
          // equalPrincipal
          if(prepay.mode === "reducePayment"){
            // é‡æ–°è®¡ç®—æ¯æœˆæœ¬é‡‘=å‰©ä½™æœ¬é‡‘/å‰©ä½™æœŸæ•°
            // ç­‰åˆ°æ›´æ–° remainingMonthsPlan åå†ç®—ï¼Œè¿™é‡Œå…ˆä¸ç®—
          }else{
            // shortenTerm: principalFixed ä¸å˜
          }
        }
      }

      // æ›´æ–°å‰©ä½™æœŸæ•°ï¼ˆå¯¹ reducePayment æ¥è¯´å¿…é¡»æ§åˆ¶æœŸæ•°ï¼›å¯¹ shortenTerm åªæ˜¯ç»Ÿè®¡ç”¨ï¼‰
      remainingMonthsPlan = Math.max(0, remainingMonthsPlan - 1);

      // æå‰è¿˜æ¬¾åéœ€è¦é‡æ–°å®šè®¡åˆ’ï¼ˆreducePaymentï¼‰
      if(prepayApplied && prepay && compareYM(ym, prepay.ym) === 0){
        if(prepay.mode === "reducePayment"){
          if(method === "annuity"){
            payment = annuityPayment(bal, getRate(addMonths(ym,1)), remainingMonthsPlan);
            // æ³¨æ„ï¼šé‡ç®—é€šå¸¸ä»ä¸‹æœŸå¼€å§‹ï¼Œå› æ­¤ç”¨ä¸‹ä¸ªæœˆåˆ©ç‡é¢„ä¼°ï¼ˆæ›´è´´è¿‘å®é™…ï¼‰
          }else{
            principalFixed = (remainingMonthsPlan>0)? (bal / remainingMonthsPlan) : bal;
          }
        }else{
          // shortenTerm: å¯¹ equalPrincipal éœ€è¦è°ƒæ•´ remainingMonthsPlan ä¸ºâ€œé¢„è®¡è¿˜æ¸…æœˆæ•°â€
          if(method === "equalPrincipal"){
            if(principalFixed > 1e-12){
              remainingMonthsPlan = Math.ceil(bal / principalFixed);
            }
          }else{
            // annuity shortenTerm: remainingMonthsPlan ä¸å†å¼ºçº¦æŸï¼Œç»§ç»­æ¨¡æ‹Ÿç›´åˆ° bal=0ï¼›è¿™é‡Œä¿æŒä¸ºâ€œå‰©ä½™è®¡åˆ’æœŸæ•°â€ä¹Ÿæ— å¦¨
          }
        }
      }

      // åˆ°ä¸‹ä¸€æœˆ
      ym = addMonths(ym, 1);
      monthIndex++;
    }

    const endYM = schedule.length ? schedule[schedule.length-1].ym : {...startYM};
    const firstPay = schedule.length ? schedule[0].payment : 0;
    const maxPay = schedule.reduce((m,x)=>Math.max(m,x.payment), 0);
    const minPay = schedule.reduce((m,x)=>Math.min(m,x.payment), schedule.length? schedule[0].payment : 0);

    return {
      schedule,
      totalInterest,
      totalPayment,
      months: schedule.length,
      firstPay,
      maxPay,
      minPay,
      endYM,
      payoffYM: schedule.length ? addMonths(endYM, 0) : startYM // ç»“æ¸…å‘ç”Ÿåœ¨ endYM å½“æœŸè¿˜æ¬¾å
    };
  }

  // ======== ä¸¤ç¬”è´·æ¬¾ + æå‰è¿˜æ¬¾åˆ†é… ========
  function readLoan(prefix){
    const start = parseMonth(document.getElementById(prefix+"Start").value);
    const amount = Number(document.getElementById(prefix+"Amount").value || 0);
    const rate = Number(document.getElementById(prefix+"Rate").value || 0);
    const years = Number(document.getElementById(prefix+"Years").value || 0);
    const method = document.getElementById(prefix+"Method").value;
    const note = document.getElementById(prefix+"Note").value || "";
    const changes = readRateRows(prefix);
    return {
      start, amount, rate, years, method, note, changes
    };
  }

  function validateLoan(loan){
    const errs = [];
    if(!loan.start) errs.push("èµ·å§‹å¹´æœˆæ— æ•ˆ");
    if(loan.amount < 0 || !isFinite(loan.amount)) errs.push("è´·æ¬¾é‡‘é¢æ— æ•ˆ");
    if(loan.amount > 0){
      if(!(loan.rate > 0)) errs.push("åˆ©ç‡éœ€ > 0");
      if(!(loan.years > 0)) errs.push("å¹´é™éœ€ > 0");
    }
    return errs;
  }

  function splitPrepay(alloc, prepayAmt, bizBalAtDate, gjjBalAtDate){
    // è¿”å› {bizExtra, gjjExtra}
    prepayAmt = Math.max(0, prepayAmt);
    const total = Math.max(0, bizBalAtDate) + Math.max(0, gjjBalAtDate);
    if(total <= 1e-9) return {bizExtra:0, gjjExtra:0};

    if(alloc === "bizFirst"){
      const bizExtra = clamp(prepayAmt, 0, bizBalAtDate);
      const gjjExtra = clamp(prepayAmt - bizExtra, 0, gjjBalAtDate);
      return {bizExtra, gjjExtra};
    }
    if(alloc === "gjjFirst"){
      const gjjExtra = clamp(prepayAmt, 0, gjjBalAtDate);
      const bizExtra = clamp(prepayAmt - gjjExtra, 0, bizBalAtDate);
      return {bizExtra, gjjExtra};
    }
    // proRata
    const bizShare = bizBalAtDate / total;
    const gjjShare = gjjBalAtDate / total;
    let bizExtra = clamp(prepayAmt * bizShare, 0, bizBalAtDate);
    let gjjExtra = clamp(prepayAmt * gjjShare, 0, gjjBalAtDate);
    // å¤„ç†æµ®ç‚¹è¯¯å·®ï¼ŒæŠŠå‰©ä½™è¡¥ç»™è¿˜èƒ½è¡¥çš„é‚£ä¸€æ–¹
    const used = bizExtra + gjjExtra;
    let left = prepayAmt - used;
    if(left > 1e-6){
      const bizRoom = bizBalAtDate - bizExtra;
      const gjjRoom = gjjBalAtDate - gjjExtra;
      const addBiz = clamp(left, 0, bizRoom);
      bizExtra += addBiz; left -= addBiz;
      const addGjj = clamp(left, 0, gjjRoom);
      gjjExtra += addGjj; left -= addGjj;
    }
    return {bizExtra, gjjExtra};
  }

  function getBalanceAt(schedule, targetYM){
    // schedule ä¸­ ym æ˜¯å½“æœŸè¿˜æ¬¾å‘ç”Ÿæœˆä»½ï¼›è¿”å›è¯¥æœˆè¿˜æ¬¾åä½™é¢ï¼›è‹¥ targetYM æ—©äºé¦–æœŸåˆ™è¿”å›åˆå§‹å‰ä½™é¢ä¸å¯å¾— -> è¿”å› null
    for(const row of schedule){
      if(compareYM(row.ym, targetYM) === 0) return row.balance;
    }
    return null;
  }

  // ======== è®¡ç®—å…¥å£ ========
  let lastCSV = null;
  function calculateAll(){
    const biz = readLoan("biz");
    const gjj = readLoan("gjj");

    const errs = [];
    errs.push(...validateLoan(biz).map(e=>"å•†è´·ï¼š"+e));
    errs.push(...validateLoan(gjj).map(e=>"å…¬ç§¯é‡‘ï¼š"+e));

    // è‡³å°‘ä¸€ç¬”é‡‘é¢>0
    if((biz.amount||0) <= 0 && (gjj.amount||0) <= 0){
      errs.push("è¯·è‡³å°‘å¡«å†™ä¸€ç¬”è´·æ¬¾é‡‘é¢ï¼ˆå•†è´·æˆ–å…¬ç§¯é‡‘ï¼‰ã€‚");
    }
    if(errs.length){
      renderError(errs);
      return;
    }

    // åŸºå‡†ï¼ˆæ— æå‰è¿˜æ¬¾ï¼‰
    const baseBiz = (biz.amount>0)? simulateLoan({
      principal: biz.amount,
      startYM: biz.start,
      totalMonths: Math.round(biz.years*12),
      method: biz.method,
      initialAnnualRate: biz.rate/100,
      rateChanges: biz.changes,
      prepay: null
    }) : emptySim(biz.start);

    const baseGjj = (gjj.amount>0)? simulateLoan({
      principal: gjj.amount,
      startYM: gjj.start,
      totalMonths: Math.round(gjj.years*12),
      method: gjj.method,
      initialAnnualRate: gjj.rate/100,
      rateChanges: gjj.changes,
      prepay: null
    }) : emptySim(gjj.start);

    // æå‰è¿˜æ¬¾å‚æ•°
    const preYM = parseMonth(document.getElementById("prepayDate").value);
    const preAmt = Number(document.getElementById("prepayAmount").value || 0);
    const alloc = document.getElementById("prepayAlloc").value;
    const mode = document.getElementById("prepayMode").value;

    let afterBiz = baseBiz, afterGjj = baseGjj;
    let prepayEnabled = preYM && preAmt>0;

    if(prepayEnabled){
      // å…ˆè·‘ä¸€éâ€œåœ¨å½“æœˆè¿˜æ¬¾åä½™é¢â€ä»¥ä¾¿åˆ†é…
      // å¦‚æœç›®æ ‡æœˆä»½ä¸åœ¨ schedule å†…ï¼ˆæ¯”å¦‚æ¯”èµ·å§‹æœˆæ—©/æˆ–å·²ç»“æ¸…ï¼‰ï¼Œåˆ™è§†ä¸ºä¸å¯ç”¨ï¼šæå‰è¿˜æ¬¾æ— æ•ˆ
      const bizBal = (biz.amount>0)? getBalanceAt(baseBiz.schedule, preYM) : 0;
      const gjjBal = (gjj.amount>0)? getBalanceAt(baseGjj.schedule, preYM) : 0;

      // è‹¥è¯¥æœˆä¸åœ¨è¿˜æ¬¾æœŸå†…
      if((biz.amount>0 && bizBal===null) && (gjj.amount>0 && gjjBal===null)){
        prepayEnabled = false;
      }else{
        const bizBalUse = (bizBal===null)? 0 : bizBal;
        const gjjBalUse = (gjjBal===null)? 0 : gjjBal;
        const split = splitPrepay(alloc, preAmt, bizBalUse, gjjBalUse);

        afterBiz = (biz.amount>0)? simulateLoan({
          principal: biz.amount,
          startYM: biz.start,
          totalMonths: Math.round(biz.years*12),
          method: biz.method,
          initialAnnualRate: biz.rate/100,
          rateChanges: biz.changes,
          prepay: { ym: preYM, amount: split.bizExtra, mode }
        }) : emptySim(biz.start);

        afterGjj = (gjj.amount>0)? simulateLoan({
          principal: gjj.amount,
          startYM: gjj.start,
          totalMonths: Math.round(gjj.years*12),
          method: gjj.method,
          initialAnnualRate: gjj.rate/100,
          rateChanges: gjj.changes,
          prepay: { ym: preYM, amount: split.gjjExtra, mode }
        }) : emptySim(gjj.start);
      }
    }

    renderResults({biz, gjj, baseBiz, baseGjj, afterBiz, afterGjj, prepayEnabled, preYM, preAmt, alloc, mode});
    buildCSV({biz, gjj, baseBiz, baseGjj, afterBiz, afterGjj, prepayEnabled});
  }

  function emptySim(startYM){
    return {schedule:[], totalInterest:0, totalPayment:0, months:0, firstPay:0, maxPay:0, minPay:0, endYM:startYM, payoffYM:startYM};
  }

  // ======== æ¸²æŸ“ç»“æœ ========
  function renderError(errs){
    document.getElementById("kpiBasePay").textContent = "â€”";
    document.getElementById("kpiBaseInt").textContent = "â€”";
    document.getElementById("kpiAfterPay").textContent = "â€”";
    document.getElementById("kpiAfterInt").textContent = "â€”";
    document.getElementById("summaryBlocks").innerHTML = `
      <div class="badge danger" style="margin-bottom:10px;"><span class="b"></span><span>è¾“å…¥æœ‰è¯¯</span></div>
      <div class="code">${errs.map(e=>"â€¢ "+e).join("\n")}</div>
    `;
    document.getElementById("debugOut").textContent = "â€”";
  }

  function monthsToYMD(m){
    const y = Math.floor(m/12);
    const mm = m%12;
    if(y<=0) return `${mm} ä¸ªæœˆ`;
    if(mm===0) return `${y} å¹´`;
    return `${y} å¹´ ${mm} ä¸ªæœˆ`;
  }

  function renderResults(ctx){
    const {biz, gjj, baseBiz, baseGjj, afterBiz, afterGjj, prepayEnabled, preYM, preAmt, alloc, mode} = ctx;

    // åˆè®¡ KPI
    const basePay = (baseBiz.firstPay||0) + (baseGjj.firstPay||0);
    const baseInt = (baseBiz.totalInterest||0) + (baseGjj.totalInterest||0);
    const afterPay = (afterBiz.firstPay||0) + (afterGjj.firstPay||0);
    const afterInt = (afterBiz.totalInterest||0) + (afterGjj.totalInterest||0);

    document.getElementById("kpiBasePay").textContent = `${fmtMoney(basePay)} å…ƒ`;
    document.getElementById("kpiBaseInt").textContent = `${fmtMoney(baseInt)} å…ƒ`;
    document.getElementById("kpiAfterPay").textContent = prepayEnabled ? `${fmtMoney(afterPay)} å…ƒ` : "ï¼ˆæœªå¯ç”¨ï¼‰";
    document.getElementById("kpiAfterInt").textContent = prepayEnabled ? `${fmtMoney(afterInt)} å…ƒ` : "ï¼ˆæœªå¯ç”¨ï¼‰";
    document.getElementById("kpiBasePayS").textContent = `å•†è´·+å…¬ç§¯é‡‘ Â· ä»¥é¦–æœŸæœˆä¾›ä¸ºä»£è¡¨ï¼ˆåˆ©ç‡å˜æ›´åæœˆä¾›å¯èƒ½å˜åŒ–ï¼‰`;
    document.getElementById("kpiBaseIntS").textContent = `æ€»åˆ©æ¯=å…¨æœŸåˆ©æ¯åˆè®¡`;
    document.getElementById("kpiAfterPayS").textContent = prepayEnabled ? `ç­–ç•¥ï¼š${mode==="shortenTerm"?"ç¼©çŸ­å¹´é™":"å‡å°‘æœˆä¾›"} Â· åˆ†é…ï¼š${allocText(alloc)}` : "å¡«å†™æå‰è¿˜æ¬¾å¹´æœˆä¸é‡‘é¢å³å¯å¯ç”¨";
    document.getElementById("kpiAfterIntS").textContent = prepayEnabled ? `å°‘ä»˜åˆ©æ¯ï¼š${fmtMoney(baseInt-afterInt)} å…ƒ` : "â€”";

    // é€ç¬”æ‘˜è¦
    const blocks = [];
    blocks.push(renderLoanBlock("å•†ä¸šè´·æ¬¾", biz, baseBiz, afterBiz, prepayEnabled));
    blocks.push(renderLoanBlock("å…¬ç§¯é‡‘è´·æ¬¾", gjj, baseGjj, afterGjj, prepayEnabled));

    // æ±‡æ€»å¯¹æ¯”
    const baseMonths = Math.max(baseBiz.months||0, baseGjj.months||0);
    const afterMonths = prepayEnabled ? Math.max(afterBiz.months||0, afterGjj.months||0) : null;

    let termDiffStr = "â€”";
    if(prepayEnabled && isFinite(afterMonths)){
      const diff = baseMonths - afterMonths;
      termDiffStr = diff>0 ? `ç¼©çŸ­ ${monthsToYMD(diff)}` : (diff===0 ? "æœŸé™ä¸å˜" : `å»¶é•¿ ${monthsToYMD(-diff)}ï¼ˆä¸å¸¸è§ï¼Œå»ºè®®æ£€æŸ¥è¾“å…¥ï¼‰`);
    }

    const paymentDiff = basePay - afterPay;

    blocks.unshift(`
      <div class="card" style="box-shadow:none; margin-bottom: 12px;">
        <div class="hd">
          <div class="section-title"><div class="dot" style="background:#7aa2ff;"></div><h2>åˆè®¡æ±‡æ€»</h2></div>
          <div class="badge"><span class="b"></span><span>${prepayEnabled ? "å«æå‰è¿˜æ¬¾å¯¹æ¯”" : "ä»…åŸºå‡†ï¼ˆæ— æå‰è¿˜æ¬¾ï¼‰"}</span></div>
        </div>
        <div class="bd">
          <div class="kpi">
            <div class="box">
              <div class="t">åŸºå‡†ç»“æ¸…å‘¨æœŸï¼ˆæŒ‰è¾ƒé•¿é‚£ç¬”ï¼‰</div>
              <div class="v">${monthsToYMD(baseMonths)}</div>
              <div class="s">å•†è´· ${monthsToYMD(baseBiz.months||0)} Â· å…¬ç§¯é‡‘ ${monthsToYMD(baseGjj.months||0)}</div>
            </div>
            <div class="box">
              <div class="t">æå‰è¿˜æ¬¾åå‘¨æœŸå˜åŒ–</div>
              <div class="v">${prepayEnabled ? termDiffStr : "ï¼ˆæœªå¯ç”¨ï¼‰"}</div>
              <div class="s">${prepayEnabled ? `æå‰è¿˜æ¬¾ï¼š${monthToStr(preYM)} Â· ${fmtMoney(preAmt)} å…ƒ` : "å¡«å†™æå‰è¿˜æ¬¾å³å¯è®¡ç®—ç¼©çŸ­å¹´é™æˆ–å‡å°‘æœˆä¾›"}</div>
            </div>
            <div class="box">
              <div class="t">æ€»åˆ©æ¯å˜åŒ–</div>
              <div class="v">${prepayEnabled ? `${fmtMoney(baseInt-afterInt)} å…ƒ` : "â€”"}</div>
              <div class="s">${prepayEnabled ? `å°‘ä»˜åˆ©æ¯ï¼ˆåŸºå‡† - æå‰è¿˜æ¬¾åï¼‰` : ""}</div>
            </div>
            <div class="box">
              <div class="t">é¦–æœˆæœˆä¾›å˜åŒ–</div>
              <div class="v">${prepayEnabled ? `${fmtMoney(paymentDiff)} å…ƒ` : "â€”"}</div>
              <div class="s">${prepayEnabled ? `${paymentDiff>=0 ? "å‡å°‘" : "å¢åŠ ï¼ˆæ£€æŸ¥ç­–ç•¥/è¾“å…¥ï¼‰"}ï¼ˆåŸºå‡†é¦–æœˆ - æå‰è¿˜æ¬¾åé¦–æœˆï¼‰` : ""}</div>
            </div>
          </div>
        </div>
      </div>
    `);

    document.getElementById("summaryBlocks").innerHTML = blocks.join("\n");

    // debug
    const dbg = {
      base: {
        biz: pickSim(baseBiz), gjj: pickSim(baseGjj),
        totalInterest: baseInt, firstPay: basePay
      },
      after: prepayEnabled ? {
        biz: pickSim(afterBiz), gjj: pickSim(afterGjj),
        totalInterest: afterInt, firstPay: afterPay,
        prepay: {date: monthToStr(preYM), amount: preAmt, alloc, mode}
      } : null
    };
    document.getElementById("debugOut").textContent = JSON.stringify(dbg, null, 2);
  }

  function pickSim(sim){
    return {
      months: sim.months,
      firstPay: sim.firstPay,
      totalInterest: sim.totalInterest,
      payoff: sim.schedule.length ? monthToStr(sim.schedule[sim.schedule.length-1].ym) : null,
      maxPay: sim.maxPay,
      minPay: sim.minPay
    };
  }

  function allocText(v){
    if(v==="bizFirst") return "ä¼˜å…ˆå•†è´·";
    if(v==="gjjFirst") return "ä¼˜å…ˆå…¬ç§¯é‡‘";
    return "æŒ‰å‰©ä½™æœ¬é‡‘æ¯”ä¾‹";
  }

  function renderLoanBlock(title, loan, baseSim, afterSim, prepayEnabled){
    if((loan.amount||0) <= 0){
      return `
        <div class="card" style="box-shadow:none; margin-bottom: 12px;">
          <div class="hd">
            <div class="section-title"><div class="dot" style="background:rgba(255,255,255,0.25); box-shadow:none;"></div><h2>${title}</h2></div>
            <div class="badge"><span class="b"></span><span>æœªå¡«å†™é‡‘é¢</span></div>
          </div>
          <div class="bd"><div class="muted">è¯¥éƒ¨åˆ†è´·æ¬¾é‡‘é¢ä¸º 0ï¼Œå·²è·³è¿‡è®¡ç®—ã€‚</div></div>
        </div>
      `;
    }

    const baseMonths = baseSim.months||0;
    const afterMonths = afterSim.months||0;

    const basePayoff = baseSim.schedule.length ? monthToStr(baseSim.schedule[baseSim.schedule.length-1].ym) : "â€”";
    const afterPayoff = afterSim.schedule.length ? monthToStr(afterSim.schedule[afterSim.schedule.length-1].ym) : "â€”";

    const termDiff = prepayEnabled ? (baseMonths - afterMonths) : 0;
    const interestSaved = prepayEnabled ? ((baseSim.totalInterest||0) - (afterSim.totalInterest||0)) : 0;

    // â€œå‡å°‘æœˆä¾›â€å±•ç¤ºï¼šæå‰è¿˜æ¬¾åï¼Œä»ä¸‹ä¸€æœŸå¼€å§‹çš„å…¸å‹æœˆä¾›ï¼ˆå– schedule ä¸­ prepay åçš„ç¬¬ä¸€æœŸï¼‰
    let nextPayDrop = null;
    if(prepayEnabled){
      // æ‰¾åˆ°æå‰è¿˜æ¬¾æœˆçš„ç´¢å¼•
      const pre = parseMonth(document.getElementById("prepayDate").value);
      if(pre){
        const idxBase = baseSim.schedule.findIndex(r=>compareYM(r.ym, pre)===0);
        const idxAfter = afterSim.schedule.findIndex(r=>compareYM(r.ym, pre)===0);
        if(idxBase>=0 && idxAfter>=0){
          const baseNext = baseSim.schedule[idxBase+1]?.payment;
          const afterNext = afterSim.schedule[idxAfter+1]?.payment;
          if(isFinite(baseNext) && isFinite(afterNext)){
            nextPayDrop = baseNext - afterNext;
          }
        }
      }
    }

    return `
      <div class="card" style="box-shadow:none; margin-bottom:12px;">
        <div class="hd">
          <div class="section-title"><div class="dot"></div><h2>${title}</h2></div>
          <div class="badge"><span class="b"></span><span>${loan.method==="annuity"?"ç­‰é¢æœ¬æ¯":"ç­‰é¢æœ¬é‡‘"}</span></div>
        </div>
        <div class="bd">
          <div class="kpi">
            <div class="box">
              <div class="t">åŸºå‡†é¦–æœˆæœˆä¾›</div>
              <div class="v">${fmtMoney(baseSim.firstPay)} å…ƒ</div>
              <div class="s">èŒƒå›´ï¼š${fmtMoney(baseSim.minPay)} ~ ${fmtMoney(baseSim.maxPay)} å…ƒ</div>
            </div>
            <div class="box">
              <div class="t">åŸºå‡†æ€»åˆ©æ¯ / ç»“æ¸…å¹´æœˆ</div>
              <div class="v">${fmtMoney(baseSim.totalInterest)} å…ƒ</div>
              <div class="s">ç»“æ¸…ï¼š${basePayoff} Â· å‘¨æœŸï¼š${monthsToYMD(baseMonths)}</div>
            </div>
            <div class="box">
              <div class="t">æå‰è¿˜æ¬¾åæ€»åˆ©æ¯ / ç»“æ¸…å¹´æœˆ</div>
              <div class="v">${prepayEnabled ? (fmtMoney(afterSim.totalInterest)+" å…ƒ") : "ï¼ˆæœªå¯ç”¨ï¼‰"}</div>
              <div class="s">${prepayEnabled ? `ç»“æ¸…ï¼š${afterPayoff} Â· å‘¨æœŸï¼š${monthsToYMD(afterMonths)}` : "å¡«å†™æå‰è¿˜æ¬¾å³å¯è®¡ç®—"}</div>
            </div>
            <div class="box">
              <div class="t">å°‘ä»˜åˆ©æ¯ / æœŸé™å˜åŒ– / æ¬¡æœŸæœˆä¾›å˜åŒ–</div>
              <div class="v">${prepayEnabled ? fmtMoney(interestSaved)+" å…ƒ" : "â€”"}</div>
              <div class="s">
                ${prepayEnabled ? `
                  æœŸé™ï¼š${termDiff>0 ? "ç¼©çŸ­ "+monthsToYMD(termDiff) : (termDiff===0?"ä¸å˜":"å»¶é•¿ "+monthsToYMD(-termDiff))} Â·
                  ${nextPayDrop!==null ? ("æ¬¡æœŸæœˆä¾›å‡å°‘ï¼š"+fmtMoney(nextPayDrop)+" å…ƒ") : "ï¼ˆæ¬¡æœŸæœˆä¾›å˜åŒ–ï¼šâ€”ï¼‰"}
                ` : ""}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // ======== CSV å¯¼å‡ºï¼šä¿å­˜æœ€è¿‘ä¸€æ¬¡â€œæå‰è¿˜æ¬¾åâ€çš„åˆå¹¶æ˜ç»†ï¼ˆè‹¥æœªå¯ç”¨åˆ™å¯¼å‡ºåŸºå‡†ï¼‰ ========
  function buildCSV(ctx){
    const {baseBiz, baseGjj, afterBiz, afterGjj, prepayEnabled} = ctx;

    const A = prepayEnabled ? afterBiz.schedule : baseBiz.schedule;
    const B = prepayEnabled ? afterGjj.schedule : baseGjj.schedule;

    // åˆå¹¶ä¸¤æ¡ scheduleï¼šæŒ‰å¹´æœˆå¯¹é½
    const map = new Map(); // key=YYYY-MM -> {biz..., gjj...}
    function put(arr, keyPrefix){
      for(const r of arr){
        const k = monthToStr(r.ym);
        if(!map.has(k)) map.set(k, {});
        map.get(k)[keyPrefix] = r;
      }
    }
    put(A, "biz");
    put(B, "gjj");

    const keys = [...map.keys()].sort();
    const rows = [];
    const header = [
      "å¹´æœˆ",
      "å•†è´·_åˆ©ç‡","å•†è´·_æœˆä¾›","å•†è´·_åˆ©æ¯","å•†è´·_æœ¬é‡‘","å•†è´·_æå‰è¿˜æ¬¾","å•†è´·_ä½™é¢",
      "å…¬ç§¯é‡‘_åˆ©ç‡","å…¬ç§¯é‡‘_æœˆä¾›","å…¬ç§¯é‡‘_åˆ©æ¯","å…¬ç§¯é‡‘_æœ¬é‡‘","å…¬ç§¯é‡‘_æå‰è¿˜æ¬¾","å…¬ç§¯é‡‘_ä½™é¢",
      "åˆè®¡_æœˆä¾›","åˆè®¡_åˆ©æ¯","åˆè®¡_æœ¬é‡‘","åˆè®¡_æå‰è¿˜æ¬¾","åˆè®¡_ä½™é¢"
    ];
    rows.push(header.join(","));

    for(const k of keys){
      const o = map.get(k) || {};
      const br = o.biz || null;
      const gr = o.gjj || null;

      const bizPay = br ? br.payment : 0;
      const bizInt = br ? br.interest : 0;
      const bizPri = br ? br.principal : 0;
      const bizEx  = br ? br.extra : 0;
      const bizBal = br ? br.balance : (A.length? null : 0);

      const gjjPay = gr ? gr.payment : 0;
      const gjjInt = gr ? gr.interest : 0;
      const gjjPri = gr ? gr.principal : 0;
      const gjjEx  = gr ? gr.extra : 0;
      const gjjBal = gr ? gr.balance : (B.length? null : 0);

      const sumPay = bizPay + gjjPay;
      const sumInt = bizInt + gjjInt;
      const sumPri = bizPri + gjjPri;
      const sumEx  = bizEx + gjjEx;

      // åˆè®¡ä½™é¢ï¼šè‹¥æŸç¬”åœ¨æ­¤æœˆæ— è®°å½•ï¼ˆå·²ç»“æ¸…æˆ–æœªå¼€å§‹ï¼‰ï¼Œç”¨ 0 å¤„ç†
      const sumBal = (isFinite(bizBal)?bizBal:0) + (isFinite(gjjBal)?gjjBal:0);

      const line = [
        k,
        br ? (br.rate*100).toFixed(4)+"%" : "",
        br ? br.payment.toFixed(2) : "",
        br ? br.interest.toFixed(2) : "",
        br ? br.principal.toFixed(2) : "",
        br ? br.extra.toFixed(2) : "",
        br ? br.balance.toFixed(2) : "",
        gr ? (gr.rate*100).toFixed(4)+"%" : "",
        gr ? gr.payment.toFixed(2) : "",
        gr ? gr.interest.toFixed(2) : "",
        gr ? gr.principal.toFixed(2) : "",
        gr ? gr.extra.toFixed(2) : "",
        gr ? gr.balance.toFixed(2) : "",
        sumPay.toFixed(2),
        sumInt.toFixed(2),
        sumPri.toFixed(2),
        sumEx.toFixed(2),
        sumBal.toFixed(2)
      ];
      rows.push(line.join(","));
    }

    lastCSV = rows.join("\n");
  }

  function downloadCSV(){
    if(!lastCSV){
      alert("è¯·å…ˆç‚¹å‡»â€œå¼€å§‹è®¡ç®—â€ï¼Œå†ä¸‹è½½ CSVã€‚");
      return;
    }
    const blob = new Blob([lastCSV], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "æˆ¿è´·è¿˜æ¬¾æ˜ç»†.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ======== ç¤ºä¾‹æ•°æ® ========
  function fillDemo(){
    document.getElementById("bizStart").value = "2026-01";
    document.getElementById("bizAmount").value = 1200000;
    document.getElementById("bizRate").value = 4.10;
    document.getElementById("bizYears").value = 30;
    document.getElementById("bizMethod").value = "annuity";
    clearRateRows("biz");
    addRateRow("biz", {date:"2027-01", rate:"4.35"});
    addRateRow("biz", {date:"2029-01", rate:"4.05"});

    document.getElementById("gjjStart").value = "2026-01";
    document.getElementById("gjjAmount").value = 600000;
    document.getElementById("gjjRate").value = 3.10;
    document.getElementById("gjjYears").value = 30;
    document.getElementById("gjjMethod").value = "annuity";
    clearRateRows("gjj");
    addRateRow("gjj", {date:"2028-01", rate:"3.25"});

    document.getElementById("prepayDate").value = "2030-06";
    document.getElementById("prepayAmount").value = 200000;
    document.getElementById("prepayAlloc").value = "proRata";
    document.getElementById("prepayMode").value = "shortenTerm";
  }

  // ======== Theme: system / light / dark + smooth transition ========
  (function initTheme(){
    const KEY = "verdvana_theme"; // 'system' | 'light' | 'dark'
    const html = document.documentElement;
    const toggle = document.getElementById("themeToggle");
    const label = document.getElementById("themeLabel");
    const wrap = document.getElementById("themeSwitchWrap");

    if(!toggle || !label || !wrap) return;

    const systemPrefersDark = () =>
      window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;

    function withTransition(fn){
      html.classList.add("theme-transition");
      try{ fn(); } finally{
        window.setTimeout(()=> html.classList.remove("theme-transition"), 280);
      }
    }

    function apply(mode){
      // mode: 'system' | 'light' | 'dark'
      if(mode === "system"){
        html.removeAttribute("data-theme"); // let CSS prefers-color-scheme decide
        toggle.checked = systemPrefersDark();
        label.textContent = "ç³»ç»Ÿ";
      }else{
        html.setAttribute("data-theme", mode);
        toggle.checked = (mode === "dark");
        label.textContent = (mode === "dark") ? "æ·±è‰²" : "æµ…è‰²";
      }
      if(toggle.checked) wrap.classList.add("on");
      else wrap.classList.remove("on");
    }

    function getSaved(){
      return localStorage.getItem(KEY) || "system";
    }
    function save(mode){
      localStorage.setItem(KEY, mode);
    }

    // åˆå§‹
    apply(getSaved());

    // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼šä»…å½“å½“å‰ä¸º system æ—¶è·Ÿéš
    const mql = window.matchMedia("(prefers-color-scheme: dark)");
    const onSystemChange = () => {
      if(getSaved() === "system") withTransition(()=>apply("system"));
    };
    if(mql && mql.addEventListener) mql.addEventListener("change", onSystemChange);
    else if(mql && mql.addListener) mql.addListener(onSystemChange);

    // ç‚¹å‡»å¼€å…³ï¼šæµ…è‰² â†” æ·±è‰²ï¼›æŒ‰ä½ Alt/Option ç‚¹å‡» -> åˆ‡å› system
    toggle.addEventListener("click", (e) => {
      const alt = e.altKey;
      if(alt){
        save("system");
        withTransition(()=>apply("system"));
        return;
      }
      const next = toggle.checked ? "dark" : "light";
      save(next);
      withTransition(()=>apply(next));
    });

    // é•¿æŒ‰ï¼ˆç§»åŠ¨ç«¯ï¼‰ä¹Ÿåˆ‡å› systemï¼š800ms
    let pressTimer = null;
    wrap.addEventListener("pointerdown", () => {
      pressTimer = setTimeout(() => {
        save("system");
        withTransition(()=>apply("system"));
        wrap.title = "å·²åˆ‡å›ï¼šç³»ç»Ÿ";
        setTimeout(()=> wrap.title = "åˆ‡æ¢æ˜æš—æ¨¡å¼ï¼ˆAlt/Option ç‚¹å‡»æˆ–é•¿æŒ‰å¯åˆ‡å›ç³»ç»Ÿï¼‰", 1200);
      }, 800);
    });
    wrap.addEventListener("pointerup", () => { if(pressTimer) clearTimeout(pressTimer); });
    wrap.addEventListener("pointercancel", () => { if(pressTimer) clearTimeout(pressTimer); });
  })();

  

// ======== Left sidebar: collapse/expand + overlay + back ========
(function initSidebar(){
  const sb = document.getElementById('sidebar');
  const btn = document.getElementById('sbToggle');
  const back = document.getElementById('sbBack');
  const backdrop = document.getElementById('sbBackdrop');
  if(!sb || !btn) return;

  // Default: collapsed
  sb.classList.remove('is-expanded');

  const mq = window.matchMedia ? window.matchMedia('(max-width: 720px)') : null;
  const isMobile = () => mq ? mq.matches : (window.innerWidth <= 720);

  function setIcon(){
    const icon = btn.querySelector('i');
    if(!icon) return;
    icon.className = sb.classList.contains('is-expanded')
      ? 'fa-solid fa-chevron-left'
      : 'fa-solid fa-bars';
  }

  function syncOverlay(){
    const active = sb.classList.contains('is-expanded') && isMobile();
    if(backdrop) backdrop.classList.toggle('is-active', active);
    document.body.classList.toggle('sb-lock-scroll', active);
  }

  function collapse(){
    sb.classList.remove('is-expanded');
    setIcon();
    syncOverlay();
  }

  setIcon();
  syncOverlay();

  btn.addEventListener('click', () => {
    sb.classList.toggle('is-expanded');
    setIcon();
    syncOverlay();
  });

  // click overlay to close
  if(backdrop){
    backdrop.addEventListener('click', collapse);
    backdrop.addEventListener('touchstart', collapse, {passive:true});
  }

  // ESC to close (mobile expanded)
  window.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' && sb.classList.contains('is-expanded') && isMobile()) collapse();
  });

  // resize sync
  window.addEventListener('resize', syncOverlay);
  if(mq && mq.addEventListener) mq.addEventListener('change', syncOverlay);
  else if(mq && mq.addListener) mq.addListener(syncOverlay);

  // Back: prefer history; fallback to parent path; final fallback to labs
  if(back){
    back.addEventListener('click', () => {
      try{
        if(history.length > 1){
          history.back();
          return;
        }
      }catch(e){}
      try{
        const u = new URL(window.location.href);
        let p = u.pathname.replace(/\/+$/, '');
        const idx = p.lastIndexOf('/');
        if(idx > 0){
          u.pathname = p.slice(0, idx + 1);
          window.location.assign(u.toString());
          return;
        }
      }catch(e){}
      window.location.assign('https://verdvana.cn/labs/');
    });
  }
})();

// åˆå§‹åŒ–ï¼šé»˜è®¤ä¸åŠ èŠ‚ç‚¹
  // addRateRow('biz'); addRateRow('gjj'); // å¦‚ä½ æƒ³é»˜è®¤ä¸€è¡Œå¯å–æ¶ˆæ³¨é‡Š
</script>
</body>
</html>
