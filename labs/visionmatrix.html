<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionMatrix 视觉阵列转换器</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #007aff;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.72);
            --text-color: #1d1d1f;
            --border-color: rgba(255, 255, 255, 0.4);
            --shadow: 0 10px 40px rgba(31, 38, 135, 0.1);
            --switch-bg: #e9e9ea;
        }

        [data-theme="dark"] {
            --primary-color: #0a84ff;
            --bg-gradient: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%);
            --card-bg: rgba(28, 28, 30, 0.75);
            --text-color: #f5f5f7;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            --switch-bg: #39393d;
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-gradient); background-attachment: fixed;
            color: var(--text-color); margin: 0; padding: 20px;
            min-height: 100vh; display: flex; justify-content: center;
        }

        .container { width: 100%; max-width: 900px; z-index: 1; }

        /* iOS Switch */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .ios-switch-label { display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .switch { position: relative; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--switch-bg); transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Card Style */
        .card {
            background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color); border-radius: 20px;
            padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px;
        }

        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }

        .upload-area { border: 2px dashed var(--primary-color); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; }
        
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 12px; opacity: 0.6; font-weight: 600; text-transform: uppercase; }
        
        select, input[type="range"] { accent-color: var(--primary-color); }
        select { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px; border-radius: 10px; font-size: 13px; }

        textarea {
            width: 100%; height: 100px; background: rgba(0,0,0,0.05); border: 1px solid var(--border-color);
            border-radius: 12px; color: var(--text-color); padding: 12px; font-family: 'SF Mono', monospace; font-size: 11px; resize: none;
        }

        button { background: var(--primary-color); color: white; border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; font-weight: 600; }
        button.secondary { background: rgba(142, 142, 147, 0.2); color: var(--text-color); }

        .preview-container { background: #000; border-radius: 12px; padding: 15px; margin-bottom: 15px; display: flex; justify-content: center; overflow: hidden; }
        canvas { max-width: 100%; height: auto; image-rendering: pixelated; }

        #ascii-preview { background: #000; color: #fff; padding: 15px; border-radius: 12px; overflow-x: auto; white-space: pre; font-family: 'Courier New', monospace; line-height: 1; font-size: 8px; text-align: center; }
        .hidden { display: none; }
        .blob { position: fixed; width: 400px; height: 400px; background: var(--primary-color); filter: blur(100px); border-radius: 50%; z-index: -1; opacity: 0.1; }
    </style>

<style id="vv-sidebar-compat">
/* When Verdvana sidebar is mounted, let main handle centering/padding */
body.vv-has-sidebar{ display:block; justify-content: initial; padding:0; }
body.vv-has-sidebar .vv-main{ padding:20px; display:flex; justify-content:center; }
body.vv-has-sidebar .vv-main > .container{ width:100%; max-width:900px; }
</style>

</head>
<body>

<div class="blob" style="top: -150px; left: -100px;"></div>
<div class="blob" style="bottom: -150px; right: -100px; background: #ff3b30;"></div>

<div class="container">
    <header>
        <div>
            <h1 style="margin:0; font-size: 24px; letter-spacing: -0.5px;">VisionMatrix 视觉阵列转换器</h1>
            <p style="margin:4px 0 0; opacity: 0.5; font-size: 13px;">Base64 · 字符画 · 多位深RGB/灰度点阵</p>
        </div>
        <label class="ios-switch-label">
            <span id="theme-text">深色</span>
            <div class="switch">
                <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </div>
        </label>
    </header>

    <div class="card">
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p id="upload-text" style="margin:0">点击上传或拖拽图片到此区域，或直接Ctrl/Command+V粘贴剪贴板中的图片</p>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
        </div>
    </div>

    <div id="result-container" class="hidden">
        <div class="card">
            <div class="section-title">Base64 编码 <button onclick="copyText('base64-output')">复制</button></div>
            <textarea id="base64-output" readonly></textarea>
        </div>

        <div class="card">
            <div class="section-title">ASCII 字符画 <button onclick="copyText('ascii-preview', true)">复制</button></div>
            <div class="controls">
                <div class="control-group">
                    <label>宽度: <span id="ascii-w-val">100</span></label>
                    <input type="range" id="ascii-w" min="40" max="250" value="100" oninput="updateAll()">
                </div>
                <div class="control-group">
                    <label>操作</label>
                    <button class="secondary" onclick="document.getElementById('ascii-preview').style.filter = (document.getElementById('ascii-preview').style.filter === 'invert(1)') ? 'invert(0)' : 'invert(1)'">反相显示</button>
                </div>
            </div>
            <div id="ascii-preview"></div>
        </div>

        <div class="card">
            <div class="section-title">灰度亮点矩阵 <button onclick="copyText('gray-code')">复制代码</button></div>
            <div class="preview-container"><canvas id="gray-canvas"></canvas></div>
            <div class="controls">
                <div class="control-group">
                    <label>宽度: <span id="gray-w-val">32</span></label>
                    <input type="range" id="gray-w" min="8" max="128" value="32" oninput="updateAll()">
                </div>
                <div class="control-group">
                    <label>位深 (Bit)</label>
                    <select id="gray-bit" onchange="updateAll()">
                        <option value="1">1-bit (黑白)</option>
                        <option value="2">2-bit (4级灰度)</option>
                        <option value="4" selected>4-bit (16级灰度)</option>
                        <option value="8">8-bit (256级灰度)</option>
                    </select>
                </div>
            </div>
            <textarea id="gray-code" readonly placeholder="C语言代码..."></textarea>
        </div>

        <div class="card">
            <div class="section-title">RGB 亮点矩阵 <button onclick="copyText('rgb-code')">复制代码</button></div>
            <div class="preview-container"><canvas id="rgb-canvas"></canvas></div>
            <div class="controls" style="grid-template-columns: repeat(4, 1fr);">
                <div class="control-group"><label>宽度: <span id="rgb-w-val">32</span></label><input type="range" id="rgb-w" min="8" max="128" value="32" oninput="updateAll()"></div>
                <div class="control-group"><label>R 位</label><select id="r-bit" onchange="updateAll()"></select></div>
                <div class="control-group"><label>G 位</label><select id="g-bit" onchange="updateAll()"></select></div>
                <div class="control-group"><label>B 位</label><select id="b-bit" onchange="updateAll()"></select></div>
            </div>
            <textarea id="rgb-code" readonly placeholder="C语言代码..."></textarea>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    let originalImg = new Image();
 const uploadArea = document.querySelector('.upload-area');

 // 统一入口：选择文件/剪贴板粘贴都复用
 function loadImageFile(file) {
  if (!file) return;
  if (!file.type || !file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
   originalImg.src = ev.target.result;
   document.getElementById('base64-output').value = ev.target.result;
   document.getElementById('result-container').classList.remove('hidden');
  };
  reader.readAsDataURL(file);
 }


    // 初始化 RGB 下拉框
    ['r-bit', 'g-bit', 'b-bit'].forEach((id, idx) => {
        const s = document.getElementById(id);
        for(let i=1; i<=8; i++) {
            let o = new Option(i + ' bit', i);
            if((idx===0 && i===5) || (idx===1 && i===6) || (idx===2 && i===5)) o.selected = true;
            s.add(o);
        }
    });

    function toggleTheme() {
        const isDark = document.getElementById('theme-toggle').checked;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        document.getElementById('theme-text').innerText = isDark ? '浅色' : '深色';
    }

    fileInput.addEventListener('change', (e) => {
  const file = e.target.files && e.target.files[0];
  loadImageFile(file);
 });

 // 让上传区可聚焦：点击区域后可直接 Ctrl+V / ⌘V 粘贴
 if (uploadArea) {
  uploadArea.tabIndex = 0;
  uploadArea.addEventListener('click', () => uploadArea.focus());
 }

 // 新增：全页面监听剪贴板粘贴图片
 document.addEventListener('paste', (e) => {
  const dt = e.clipboardData;
  if (!dt || !dt.items) return;

  const imgItem = Array.from(dt.items).find(it => it.type && it.type.startsWith('image/'));
  if (!imgItem) return;

  const file = imgItem.getAsFile();
  if (!file) return;

  // 避免图片以文本等形式插入页面
  e.preventDefault();

  loadImageFile(file);

  // 轻提示：不改UI结构，仅短暂改动提示文案
  const tip = document.getElementById('upload-text');
  if (tip) {
   const old = tip.innerText;
   tip.innerText = '已从剪贴板粘贴图片';
   setTimeout(() => (tip.innerText = old), 1200);
  }
 });

    originalImg.onload = updateAll;

    function updateAll() {
        if(!originalImg.src) return;
        renderAscii();
        renderGray();
        renderRGB();
    }

    function renderAscii() {
        const w = parseInt(document.getElementById('ascii-w').value);
        document.getElementById('ascii-w-val').innerText = w;
        const ctx = getResizedCtx(w, true);
        const data = ctx.getImageData(0, 0, w, ctx.canvas.height).data;
        const chars = "@%#*+=-:. ";
        let res = "";
        for (let i = 0; i < data.length; i += 4) {
            const gray = 0.21*data[i] + 0.72*data[i+1] + 0.07*data[i+2];
            res += chars[Math.floor((gray/256)*chars.length)];
            if(((i/4)+1) % w === 0) res += "\n";
        }
        document.getElementById('ascii-preview').innerText = res;
    }

    function renderGray() {
        const w = parseInt(document.getElementById('gray-w').value);
        document.getElementById('gray-w-val').innerText = w;
        const bit = parseInt(document.getElementById('gray-bit').value);
        const ctx = getResizedCtx(w, false);
        const data = ctx.getImageData(0, 0, w, ctx.canvas.height).data;
        const canvas = document.getElementById('gray-canvas');
        
        let hexArr = [];
        drawMatrix(canvas, w, ctx.canvas.height, (x, y) => {
            const i = (y * w + x) * 4;
            const gray = 0.21*data[i] + 0.72*data[i+1] + 0.07*data[i+2];
            const val = Math.floor((gray / 256) * Math.pow(2, bit));
            hexArr.push(val);
            const brightness = (val / (Math.pow(2, bit) - 1)) * 255;
            return `rgb(${brightness},${brightness},${brightness})`;
        });

        document.getElementById('gray-code').value = generateCode(hexArr, bit, w, "gray");
    }

    function renderRGB() {
        const w = parseInt(document.getElementById('rgb-w').value);
        document.getElementById('rgb-w-val').innerText = w;
        const rB = parseInt(document.getElementById('r-bit').value), 
              gB = parseInt(document.getElementById('g-bit').value), 
              bB = parseInt(document.getElementById('b-bit').value);
        const ctx = getResizedCtx(w, false);
        const data = ctx.getImageData(0, 0, w, ctx.canvas.height).data;
        const canvas = document.getElementById('rgb-canvas');
        
        let hexArr = [];
        drawMatrix(canvas, w, ctx.canvas.height, (x, y) => {
            const i = (y * w + x) * 4;
            const r = data[i] >> (8-rB), g = data[i+1] >> (8-gB), b = data[i+2] >> (8-bB);
            hexArr.push((r << (gB+bB)) | (g << bB) | b);
            return `rgb(${r << (8-rB)},${g << (8-gB)},${b << (8-bB)})`;
        });

        document.getElementById('rgb-code').value = generateCode(hexArr, rB+gB+bB, w, "rgb");
    }

    function drawMatrix(canvas, w, h, colorFn) {
        const dot = 6, gap = 2;
        canvas.width = w * (dot+gap); canvas.height = h * (dot+gap);
        const ctx = canvas.getContext('2d');
        for(let y=0; y<h; y++) {
            for(let x=0; x<w; x++) {
                ctx.fillStyle = colorFn(x, y);
                ctx.beginPath();
                ctx.arc(x*(dot+gap)+dot/2, y*(dot+gap)+dot/2, dot/2, 0, Math.PI*2);
                ctx.fill();
            }
        }
    }

    function generateCode(arr, bits, w, name) {
        const type = bits <= 8 ? 'uint8_t' : (bits <= 16 ? 'uint16_t' : 'uint32_t');
        let code = `const ${type} img_${name}_data[] = {\n    `;
        arr.forEach((v, i) => {
            code += "0x" + v.toString(16).toUpperCase().padStart(Math.ceil(bits/4), '0') + (i===arr.length-1 ? "" : ", ");
            if((i+1)%8 === 0) code += "\n    ";
        });
        return code + "\n};";
    }

    function getResizedCtx(w, isAscii) {
        const canvas = document.createElement('canvas');
        const h = Math.floor(originalImg.height * (w / originalImg.width) * (isAscii ? 0.5 : 1));
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(originalImg, 0, 0, w, h);
        return ctx;
    }

    async function copyText(id, isInner) {
        const val = isInner ? document.getElementById(id).innerText : document.getElementById(id).value;
        await navigator.clipboard.writeText(val);
        alert("已复制到剪贴板");
    }
</script>



<script>
/*! Verdvana Sidebar Pack (Inject Mode / 方式B) */
(function () {
  const CONFIG = {
    logoUrl: "https://verdvana.cn/static/img/avatar.jpg",
    homeUrl: "https://verdvana.cn",
    fallbackBackUrl: "https://verdvana.cn/labs/",
    rememberState: false,
    storageKey: "vv_sidebar_expanded",
    collapsedWidth: 64,
    expandedWidth: 252,
    mobileBreakpoint: 720,
    overlayOpacity: 0.35,
    // 若本页主体容器固定，可指定：
    // targetSelector: ".container",
    items: [
      { text: "主页", href: "https://verdvana.cn",           icon: "fa-home" },
      { text: "博文", href: "https://verdvana.cn/archive/",  icon: "fa-archive" },
      { text: "分类", href: "https://verdvana.cn/tags/",     icon: "fa-tags" },
      { text: "留言", href: "https://verdvana.cn/comments/", icon: "fa-comments" },
      { text: "打赏", href: "https://verdvana.cn/merger/",   icon: "fa-coffee" },
      { text: "更多", href: "https://verdvana.cn/labs/",     icon: "fa-flask" }
    ]
  };

  function ensureFontAwesome() {
    const id = "vv-fa-css";
    if (document.getElementById(id)) return;
    const already = [...document.querySelectorAll('link[rel="stylesheet"]')]
      .some(l => (l.href || "").includes("font-awesome") || (l.href || "").includes("all.min.css"));
    if (already) return;
    const link = document.createElement("link");
    link.id = id;
    link.rel = "stylesheet";
    link.href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css";
    link.referrerPolicy = "no-referrer";
    document.head.appendChild(link);
  }

  function injectCSS() {
    const id = "vv-sidebar-style";
    if (document.getElementById(id)) return;
    const style = document.createElement("style");
    style.id = id;
    style.textContent = `
/* ===== Verdvana Sidebar (Inject) ===== */
.vv-layout{ display:flex; min-height:100vh; }
.vv-sidebar{
  --vv-sb-w: ${CONFIG.collapsedWidth}px;
  width: var(--vv-sb-w);
  flex: 0 0 var(--vv-sb-w);
  height: 100vh;
  position: sticky;
  top: 0;
  z-index: 9998;
  border-right: 1px solid var(--border-color, rgba(255,255,255,0.25));
  background: rgba(255,255,255,0.35);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display:flex;
  flex-direction: column;
  padding: 10px;
  gap: 10px;
  transition: width .18s ease, flex-basis .18s ease;
}
[data-theme="dark"] .vv-sidebar{ background: rgba(28,28,30,0.55); }
.vv-sidebar.is-expanded{ --vv-sb-w: ${CONFIG.expandedWidth}px; }
.vv-main{ flex: 1 1 auto; min-width:0; }

.vv-sb-top{ display:flex; align-items:center; gap:10px; }
.vv-sb-toggle{
  width: 40px; height: 40px;
  border-radius: 12px;
  padding: 0;
  display:grid; place-items:center;
  border: 1px solid var(--border-color, rgba(255,255,255,0.25));
  background: rgba(255,255,255,0.20);
  color: var(--text-color, #1d1d1f);
  cursor: pointer;
}
[data-theme="dark"] .vv-sb-toggle{ background: rgba(255,255,255,0.08); color: var(--text-color, #f5f5f7); }
.vv-sb-toggle:hover{ border-color: rgba(122,162,255,0.55); }

.vv-sb-logo{
  width: 40px; height: 40px;
  border-radius: 14px;
  overflow:hidden;
  border: 1px solid var(--border-color, rgba(255,255,255,0.25));
  display:block;
}
.vv-sb-logo img{ width:100%; height:100%; object-fit:cover; display:block; }

.vv-sb-nav{ display:flex; flex-direction:column; gap:6px; padding-top:6px; }
.vv-sb-item{
  display:flex; align-items:center; gap:12px;
  width:100%;
  border-radius: 12px;
  padding: 10px 10px;
  border: 1px solid transparent;
  color: var(--text-color, #1d1d1f);
  background: transparent;
  text-decoration:none;
  cursor:pointer;
  user-select:none;
  transition: background .16s ease, border-color .16s ease, transform .04s ease;
}
[data-theme="dark"] .vv-sb-item{ color: var(--text-color, #f5f5f7); }
.vv-sb-item:hover{ background: rgba(255,255,255,0.20); border-color: rgba(122,162,255,0.25); }
[data-theme="dark"] .vv-sb-item:hover{ background: rgba(255,255,255,0.08); }
.vv-sb-item:active{ transform: translateY(1px); }
.vv-sb-item i{ width: 20px; text-align:center; opacity:.92; }
.vv-sb-item span{ white-space:nowrap; font-size:13px; }

.vv-sidebar:not(.is-expanded) .vv-sb-item span{ display:none; }
.vv-sidebar:not(.is-expanded) .vv-sb-top{ flex-direction: column; align-items: stretch; }

.vv-sb-sep{ height:1px; background: var(--border-color, rgba(255,255,255,0.25)); margin:6px 2px; }
.vv-sb-bottom{ margin-top:auto; padding-top:6px; }
.vv-sb-back{ border: 1px solid var(--border-color, rgba(255,255,255,0.25)); background: rgba(255,255,255,0.18); }
[data-theme="dark"] .vv-sb-back{ background: rgba(255,255,255,0.08); }

/* Backdrop (overlay) - activated on mobile when sidebar expanded */
.vv-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0, ${CONFIG.overlayOpacity});
  opacity: 0;
  pointer-events: none;
  transition: opacity .16s ease;
  z-index: 9997;
}
.vv-backdrop.is-active{ opacity: 1; pointer-events: auto; }

@media (max-width: ${CONFIG.mobileBreakpoint}px){
  .vv-sidebar{ position: fixed; left: 0; top: 0; }
  .vv-main{ margin-left: ${CONFIG.collapsedWidth}px; }
  .vv-sidebar.is-expanded{ box-shadow: 0 18px 60px rgba(0,0,0,0.35); }
  body.vv-lock-scroll{ overflow: hidden; }
}
@media print{ .vv-sidebar, .vv-backdrop{ display:none; } .vv-main{ margin-left:0; } }
`;
    document.head.appendChild(style);
  }

  function buildSidebar() {
    const layout = document.createElement("div");
    layout.className = "vv-layout";
    layout.id = "vvLayout";

    const sidebar = document.createElement("aside");
    sidebar.className = "vv-sidebar";
    sidebar.id = "vvSidebar";
    sidebar.setAttribute("aria-label", "站点导航");

    const top = document.createElement("div");
    top.className = "vv-sb-top";

    const toggle = document.createElement("button");
    toggle.className = "vv-sb-toggle";
    toggle.id = "vvSbToggle";
    toggle.type = "button";
    toggle.setAttribute("aria-label", "展开/折叠菜单");
    toggle.title = "展开/折叠菜单";
    toggle.innerHTML = `<i class="fa-solid fa-bars" aria-hidden="true"></i>`;

    const logo = document.createElement("a");
    logo.className = "vv-sb-logo";
    logo.href = CONFIG.homeUrl;
    logo.title = "verdvana.cn";
    logo.innerHTML = `<img src="${CONFIG.logoUrl}" alt="logo">`;

    top.appendChild(toggle);
    top.appendChild(logo);

    const nav = document.createElement("nav");
    nav.className = "vv-sb-nav";
    nav.setAttribute("aria-label", "快捷入口");

    CONFIG.items.forEach(it => {
      const a = document.createElement("a");
      a.className = "vv-sb-item";
      a.href = it.href;
      a.title = it.text;
      a.innerHTML = `<i class="fa-solid ${it.icon}" aria-hidden="true"></i><span>${it.text}</span>`;
      nav.appendChild(a);
    });

    const sep = document.createElement("div");
    sep.className = "vv-sb-sep";
    sep.setAttribute("role", "separator");
    sep.setAttribute("aria-hidden", "true");
    nav.appendChild(sep);

    const bottom = document.createElement("div");
    bottom.className = "vv-sb-bottom";

    const back = document.createElement("button");
    back.className = "vv-sb-item vv-sb-back";
    back.id = "vvSbBack";
    back.type = "button";
    back.title = "返回上一级";
    back.innerHTML = `<i class="fa-solid fa-arrow-left" aria-hidden="true"></i><span>返回上一级</span>`;

    bottom.appendChild(back);

    sidebar.appendChild(top);
    sidebar.appendChild(nav);
    sidebar.appendChild(bottom);

    const backdrop = document.createElement('div');
    backdrop.className = 'vv-backdrop';
    backdrop.id = 'vvBackdrop';
    backdrop.setAttribute('aria-hidden', 'true');

    const main = document.createElement("main");
    main.className = "vv-main";
    main.id = "vvMain";

    layout.appendChild(sidebar);
    layout.appendChild(backdrop);
    layout.appendChild(main);

    return { layout, sidebar, main, toggle, back, backdrop };
  }

  function moveContentIntoMain(main) {
    const body = document.body;
    const currentScript = document.currentScript;

    if (CONFIG.targetSelector) {
      const target = document.querySelector(CONFIG.targetSelector);
      if (target) main.appendChild(target);
      return;
    }

    const nodes = [...body.childNodes];
    nodes.forEach(node => {
      if (node === currentScript) return;
      if (node.nodeType === 1) {
        const tag = node.tagName.toLowerCase();
        if (tag === "script" || tag === "style" || tag === "link") return;
      }
      if (node.nodeType === 3 && !node.nodeValue.trim()) {
        node.parentNode && node.parentNode.removeChild(node);
        return;
      }
      if (node.nodeType === 1 && (node.id === 'vvLayout' || node.id === 'vvSidebar' || node.id === 'vvMain' || node.id === 'vvBackdrop')) return;
      main.appendChild(node);
    });
  }

  function isMobile() {
    return window.matchMedia && window.matchMedia(`(max-width: ${CONFIG.mobileBreakpoint}px)`).matches;
  }

  function bindBehavior(sidebar, toggleBtn, backBtn, backdrop) {
    if (CONFIG.rememberState) {
      try {
        const saved = localStorage.getItem(CONFIG.storageKey);
        if (saved === "1") sidebar.classList.add("is-expanded");
      } catch (e) {}
    } else {
      sidebar.classList.remove("is-expanded");
    }

    function setIcon() {
      const icon = toggleBtn.querySelector("i");
      if (!icon) return;
      icon.className = sidebar.classList.contains("is-expanded")
        ? "fa-solid fa-chevron-left"
        : "fa-solid fa-bars";
    }

    function syncOverlay() {
      const expanded = sidebar.classList.contains('is-expanded');
      const mobile = isMobile();
      if (backdrop) backdrop.classList.toggle('is-active', expanded && mobile);
      document.body.classList.toggle('vv-lock-scroll', expanded && mobile);
    }

    function collapse() {
      sidebar.classList.remove('is-expanded');
      setIcon();
      syncOverlay();
      if (CONFIG.rememberState) {
        try { localStorage.setItem(CONFIG.storageKey, "0"); } catch(e) {}
      }
    }

    setIcon();
    syncOverlay();

    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("is-expanded");
      setIcon();
      syncOverlay();
      if (CONFIG.rememberState) {
        try {
          localStorage.setItem(CONFIG.storageKey, sidebar.classList.contains("is-expanded") ? "1" : "0");
        } catch (e) {}
      }
    });

    if (backdrop) {
      backdrop.addEventListener('click', collapse);
      backdrop.addEventListener('touchstart', collapse, {passive:true});
    }

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && sidebar.classList.contains('is-expanded') && isMobile()) collapse();
    });

    window.addEventListener('resize', syncOverlay);

    backBtn.addEventListener("click", () => {
      try {
        if (history.length > 1) { history.back(); return; }
      } catch (e) {}
      try {
        const u = new URL(window.location.href);
        let p = u.pathname.replace(/\/+$/, "");
        const idx = p.lastIndexOf("/");
        if (idx > 0) {
          u.pathname = p.slice(0, idx + 1);
          window.location.assign(u.toString());
          return;
        }
      } catch (e) {}
      window.location.assign(CONFIG.fallbackBackUrl);
    });
  }

  function mount() {
    document.body.classList.add('vv-has-sidebar');
    ensureFontAwesome();
    injectCSS();
    const { layout, sidebar, main, toggle, back, backdrop } = buildSidebar();
    document.body.insertBefore(layout, document.body.firstChild);
    moveContentIntoMain(main);
    bindBehavior(sidebar, toggle, back, backdrop);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", mount);
  } else {
    mount();
  }
})();
</script>

</body>
</html>